{"ast":null,"code":"/*\r\n * @copyright\r\n * Copyright © Microsoft Open Technologies, Inc.\r\n *\r\n * All Rights Reserved\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http: *www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * THIS CODE IS PROVIDED *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS\r\n * OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION\r\n * ANY IMPLIED WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A\r\n * PARTICULAR PURPOSE, MERCHANTABILITY OR NON-INFRINGEMENT.\r\n *\r\n * See the Apache License, Version 2.0 for the specific language\r\n * governing permissions and limitations under the License.\r\n */\n'use strict';\n\nvar _ = require('underscore');\n\nrequire('date-utils'); // Adds a number of convenience methods to the builtin Date object.\n\n\nvar querystring = require('querystring');\n\nvar uuid = require('uuid');\n\nvar axios = require('axios');\n\nvar url = require('url');\n\nvar async = require('async');\n\nvar constants = require('./constants');\n\nvar Logger = require('./log').Logger;\n\nvar util = require('./util');\n\nvar OAuth2Parameters = constants.OAuth2.Parameters;\nvar OAuth2ResponseParameters = constants.OAuth2.ResponseParameters;\nvar DeviceCodeResponseParameters = constants.OAuth2.DeviceCodeResponseParameters;\nvar IdTokenMap = constants.OAuth2.IdTokenMap;\nvar TokenResponseFields = constants.TokenResponseFields;\nvar UserCodeResponseFields = constants.UserCodeResponseFields;\nvar IdTokenFields = constants.IdTokenFields;\nvar TOKEN_RESPONSE_MAP = {};\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.TOKEN_TYPE] = TokenResponseFields.TOKEN_TYPE;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.ACCESS_TOKEN] = TokenResponseFields.ACCESS_TOKEN;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.REFRESH_TOKEN] = TokenResponseFields.REFRESH_TOKEN;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.CREATED_ON] = TokenResponseFields.CREATED_ON;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.EXPIRES_ON] = TokenResponseFields.EXPIRES_ON;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.EXPIRES_IN] = TokenResponseFields.EXPIRES_IN;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.RESOURCE] = TokenResponseFields.RESOURCE;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.ERROR] = TokenResponseFields.ERROR;\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.ERROR_DESCRIPTION] = TokenResponseFields.ERROR_DESCRIPTION;\nvar DEVICE_CODE_RESPONSE_MAP = {};\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.DEVICE_CODE] = UserCodeResponseFields.DEVICE_CODE;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.USER_CODE] = UserCodeResponseFields.USER_CODE;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.VERIFICATION_URL] = UserCodeResponseFields.VERIFICATION_URL;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.INTERVAL] = UserCodeResponseFields.INTERVAL;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.EXPIRES_IN] = UserCodeResponseFields.EXPIRES_IN;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.MESSAGE] = UserCodeResponseFields.MESSAGE;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.ERROR] = UserCodeResponseFields.ERROR;\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.ERROR_DESCRIPTION] = UserCodeResponseFields.ERROR_DESCRIPTION;\n/**\r\n * Constructs an instances of OAuth2Client\r\n * @constructor\r\n * @private\r\n * @param {object} callContext Contains any context information that applies to the request.\r\n * @param {string|url} authority  An url that points to an authority.\r\n */\n\nfunction OAuth2Client(callContext, authority) {\n  this._aadApiVersion = authority.aadApiVersion === undefined ? '1.0' : authority.aadApiVersion;\n  this._tokenEndpoint = authority.tokenEndpoint;\n  this._deviceCodeEndpoint = authority.deviceCodeEndpoint;\n  this._log = new Logger('OAuth2Client', callContext._logContext);\n  this._callContext = callContext;\n  this._cancelPollingRequest = false;\n}\n/**\r\n * Constructs an OAuth 2.0 token request url.\r\n * @private\r\n * @return {URL}\r\n */\n\n\nOAuth2Client.prototype._createTokenUrl = function () {\n  var tokenUrl = url.parse(this._tokenEndpoint);\n  var parameters = {};\n  parameters[OAuth2Parameters.AAD_API_VERSION] = this._aadApiVersion;\n  tokenUrl.search = querystring.stringify(parameters);\n  return tokenUrl;\n};\n/**\r\n * Constructs the user code info request url. \r\n * @private \r\n * @return {URL}\r\n */\n\n\nOAuth2Client.prototype._createDeviceCodeUrl = function () {\n  var deviceCodeUrl = url.parse(this._deviceCodeEndpoint);\n  var parameters = {};\n  parameters[OAuth2Parameters.AAD_API_VERSION] = this._aadApiVersion;\n  deviceCodeUrl.search = querystring.stringify(parameters);\n  return deviceCodeUrl;\n};\n/**\r\n * @private\r\n * @param {object}   obj         An object in which integer values may reside.\r\n * @param {array}    keys        An array of strings that specify keys in which integers may need parsing.\r\n */\n\n\nOAuth2Client.prototype._parseOptionalInts = function (obj, keys) {\n  var self = this;\n  keys.forEach(function (element) {\n    if (_.has(obj, element)) {\n      obj[element] = parseInt(obj[element], 10);\n\n      if (isNaN(obj[element])) {\n        throw self._log.createError(element + ' could not be parsed as an int.');\n      }\n    }\n  });\n};\n/**\r\n * Parses a JWS encoded JWT into it's three parts.\r\n * @param  {string} jwtToken The token to parse.\r\n * @return {object}          The three JWS parts, header, JWSPayload, and JWSSig, or undefined.\r\n */\n\n\nOAuth2Client.prototype._crackJwt = function (jwtToken) {\n  var idTokenPartsRegex = /^([^\\.\\s]*)\\.([^\\.\\s]+)\\.([^\\.\\s]*)$/;\n  var matches = idTokenPartsRegex.exec(jwtToken);\n\n  if (!matches || matches.length < 4) {\n    this._log.warn('The returned id_token is not parseable.');\n\n    return;\n  }\n\n  var crackedToken = {\n    header: matches[1],\n    JWSPayload: matches[2],\n    JWSSig: matches[3]\n  };\n  return crackedToken;\n};\n/**\r\n * Finds the value that should be used as the userId value.\r\n * @param {object} idToken The id token that parsed.\r\n * @returns {object} An object with a userId field and maybe a userIdIsDisplayable field.\r\n */\n\n\nOAuth2Client.prototype._getUserId = function (idToken) {\n  var userId;\n  var isDisplayable;\n\n  if (idToken.upn) {\n    userId = idToken.upn;\n    isDisplayable = true;\n  } else if (idToken.email) {\n    userId = idToken.email;\n    isDisplayable = true;\n  } else if (idToken.sub) {\n    userId = idToken.sub;\n  }\n\n  if (!userId) {\n    // generate a random GUID.\n    userId = uuid.v4();\n  }\n\n  var userIdVals = {};\n  userIdVals[IdTokenFields.USER_ID] = userId;\n\n  if (isDisplayable) {\n    userIdVals[IdTokenFields.IS_USER_ID_DISPLAYABLE] = true;\n  }\n\n  return userIdVals;\n};\n\nfunction mapFields(inObj, outObj, map) {\n  for (var key in inObj) {\n    if (map[key]) {\n      var mappedKey = map[key];\n      outObj[mappedKey] = inObj[key];\n    }\n  }\n}\n/**\r\n * Given a decoded id token off the wire, this function extracts the values that\r\n * ADAL commonly returns to callers and translates the names to more user\r\n * friendly names.\r\n * @param  {Object} idToken A decoded id token.\r\n * @return {Object}         The set of extracted values with their new names.\r\n */\n\n\nOAuth2Client.prototype._extractIdTokenValues = function (idToken) {\n  var extractedValues = {};\n\n  _.extend(extractedValues, this._getUserId(idToken));\n\n  mapFields(idToken, extractedValues, IdTokenMap);\n  return extractedValues;\n};\n/**\r\n * Parses the value of the id_token OAuth 2 Reponse.\r\n * @param  {string} encodedIdToken An unencrypted JWT token.\r\n * @return {object}                 returns the decoded id_token or undefined.\r\n */\n\n\nOAuth2Client.prototype._parseIdToken = function (encodedIdToken) {\n  var crackedToken = this._crackJwt(encodedIdToken);\n\n  if (!crackedToken) {\n    return;\n  }\n\n  var idToken;\n\n  try {\n    var base64IdToken = crackedToken.JWSPayload;\n    var base64Decoded = util.base64DecodeStringUrlSafe(base64IdToken);\n\n    if (!base64Decoded) {\n      this._log.warn('The returned id_token could not be base64 url safe decoded.');\n\n      return;\n    }\n\n    idToken = JSON.parse(base64Decoded);\n  } catch (err) {\n    this._log.warn('the returned id_token could not be decoded');\n\n    this._log.warn('The returned id_token could not be decoded: ' + err.stack, true);\n\n    return;\n  }\n\n  return this._extractIdTokenValues(idToken);\n};\n/**\r\n * Validates the response returned from an OAuth 2.0 token request.\r\n * @private\r\n * @param  {string} body  The response as a string encoded JSON object.\r\n * @return {object}       The parsed response.\r\n */\n\n\nOAuth2Client.prototype._validateTokenResponse = function (body) {\n  var wireResponse;\n  var tokenResponse = {};\n\n  try {\n    wireResponse = body;\n  } catch (e) {\n    throw new Error('The token response returned from the server is unparseable as JSON');\n  }\n\n  var intKeys = [OAuth2ResponseParameters.EXPIRES_ON, OAuth2ResponseParameters.EXPIRES_IN, OAuth2ResponseParameters.CREATED_ON];\n\n  this._parseOptionalInts(wireResponse, intKeys);\n\n  if (wireResponse[OAuth2ResponseParameters.EXPIRES_IN]) {\n    var expiresIn = wireResponse[OAuth2ResponseParameters.EXPIRES_IN];\n    var now = new Date();\n    wireResponse[OAuth2ResponseParameters.EXPIRES_ON] = now.add({\n      seconds: expiresIn\n    });\n  }\n\n  if (wireResponse[OAuth2ResponseParameters.CREATED_ON]) {\n    var tempDate = new Date();\n    var createdOn = wireResponse[OAuth2ResponseParameters.CREATED_ON];\n    tempDate.setTime(createdOn);\n    wireResponse[OAuth2ResponseParameters.CREATED_ON] = tempDate;\n  }\n\n  if (!wireResponse[OAuth2ResponseParameters.TOKEN_TYPE]) {\n    throw this._log.createError('wireResponse is missing token_type');\n  }\n\n  if (!wireResponse[OAuth2ResponseParameters.ACCESS_TOKEN]) {\n    throw this._log.createError('wireResponse missing access_token');\n  }\n\n  mapFields(wireResponse, tokenResponse, TOKEN_RESPONSE_MAP);\n\n  if (wireResponse[OAuth2ResponseParameters.ID_TOKEN]) {\n    var idToken = this._parseIdToken(wireResponse[OAuth2ResponseParameters.ID_TOKEN]);\n\n    if (idToken) {\n      _.extend(tokenResponse, idToken);\n    }\n  }\n\n  return tokenResponse;\n};\n/**\r\n * Validates the response returned from an OAuth 2.0 device code request.\r\n * @private\r\n * @param  {string} body  The response as a string encoded JSON object.\r\n * @return {object}       The parsed response.\r\n */\n\n\nOAuth2Client.prototype._validateDeviceCodeResponse = function (body) {\n  var wireResponse;\n  var deviceCodeResponse = {};\n\n  try {\n    wireResponse = body;\n  } catch (e) {\n    throw new Error('The device code response returned from the server is unparseable as JSON.');\n  }\n\n  var intKeys = [DeviceCodeResponseParameters.EXPIRES_IN, DeviceCodeResponseParameters.INTERVAL];\n\n  this._parseOptionalInts(wireResponse, intKeys);\n\n  if (!wireResponse[DeviceCodeResponseParameters.EXPIRES_IN]) {\n    throw this._log.createError('wireResponse is missing expires_in');\n  }\n\n  if (!wireResponse[DeviceCodeResponseParameters.DEVICE_CODE]) {\n    throw this._log.createError('wireResponse is missing device code');\n  }\n\n  if (!wireResponse[DeviceCodeResponseParameters.USER_CODE]) {\n    throw this._log.createError('wireResponse is missing user code');\n  }\n\n  mapFields(wireResponse, deviceCodeResponse, DEVICE_CODE_RESPONSE_MAP);\n  return deviceCodeResponse;\n};\n/**\r\n * @private\r\n * @param {string}                   body        The body of a http token response.\r\n */\n\n\nOAuth2Client.prototype._handlePollingResponse = function (body) {\n  //handle token error response\n  var tokenResponse = this._handlePollingRequestErrorResponse(body);\n\n  if (_.isEmpty(tokenResponse)) {\n    tokenResponse = this._validateTokenResponse(body);\n  }\n\n  return tokenResponse;\n};\n/**\r\n * @private\r\n * @param {string}                   body        The body of a http token response.\r\n */\n\n\nOAuth2Client.prototype._handlePollingRequestErrorResponse = function (body) {\n  var wireResponse;\n  var tokenResponse = {};\n\n  try {\n    wireResponse = body;\n  } catch (e) {\n    throw new Error('The token response returned from the server is unparsable as JSON');\n  }\n\n  if (wireResponse[OAuth2ResponseParameters.ERROR]) {\n    mapFields(wireResponse, tokenResponse, TOKEN_RESPONSE_MAP);\n  }\n\n  return tokenResponse;\n};\n/**\r\n * @private\r\n * @param {object}                   response    An http response object.\r\n * @param {string}                   body        The body of a http token response.\r\n * @param {OAuth2Client.GetTokenCallback}    callback    A call back function.  The body parameter is the body parameter passed\r\n *                                               into this function.\r\n */\n\n\nOAuth2Client.prototype._handleGetTokenResponse = function (body, callback) {\n  var tokenResponse;\n\n  try {\n    tokenResponse = this._validateTokenResponse(body);\n  } catch (e) {\n    this._log.error('Error validating get token response', e, true);\n\n    callback(e);\n    return;\n  }\n\n  callback(null, tokenResponse);\n};\n\nOAuth2Client.prototype._handleGetDeviceCodeResponse = function (body, callback) {\n  var deviceCodeResponse;\n\n  try {\n    deviceCodeResponse = this._validateDeviceCodeResponse(body);\n  } catch (e) {\n    this._log.error('Error validating get user code response', e, true);\n\n    callback(e);\n    return;\n  }\n\n  callback(null, deviceCodeResponse);\n};\n\nOAuth2Client.prototype._getTokenWithPolling = function (postOptions, callback) {\n  var self = this;\n\n  if (self._cancelPollingRequest === true) {\n    callback(null, new Error('Polling_Request_Cancelled'));\n    return;\n  }\n\n  axios(postOptions).then(response => {\n    var tokenResponse;\n    util.logReturnCorrelationId(this._log, 'GetToken', response);\n\n    try {\n      tokenResponse = self._handlePollingResponse(response.data);\n    } catch (e) {\n      self._log.error('Error validating get token response', e, true);\n\n      callback(null, e);\n      return;\n    }\n\n    callback(null, tokenResponse);\n  }).catch(error => {\n    // status >= 400: error case\n    if (error.response) {\n      util.logReturnCorrelationId(this._log, 'GetToken', error.response); // error response callback, for error response, it's already parsed as Json. \n\n      if (error.response && error.response.data.hasOwnProperty(TokenResponseFields.ERROR) && error.response.data[TokenResponseFields.ERROR] === 'authorization_pending') {\n        callback(new Error(error.response.data[TokenResponseFields.ERROR]), error.response.data);\n      }\n    } // if there is no response from the server\n    else if (error.request) {\n        self._log.error('GetToken' + ' request was made but no response was received', error.request, true);\n\n        callback(self._log.createError('No response from the server'));\n      } // request was never made\n      else if (error.message) {\n          self._log.error('GetToken http get failed.' + ' request was never made, please check', error.message, true);\n\n          callback(error.message);\n        } // unknown error\n        else {\n            self._log.error('GetToken' + ' failed with unknown error', \"unknown error\", true);\n\n            callback(self._log.createError('failed with an unknown error'));\n          }\n  });\n};\n\nOAuth2Client.prototype._createPostOption = function (postUrl, urlEncodedRequestForm) {\n  var postOptions = util.createRequestOptions(this, {\n    method: 'POST',\n    url: url.format(postUrl),\n    data: urlEncodedRequestForm,\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded'\n    },\n    maxRedirects: 0,\n    encoding: 'utf8'\n  });\n  return postOptions;\n};\n/**\r\n * @callback GetTokenCallback\r\n * @memberOf OAuth2Client\r\n * @param {Error} [error] In case of an error this will hold the associated Error object.\r\n * @param {TokenResponse} tokenResponse Contains the parsed result of a get token request.\r\n */\n\n/**\r\n* @param {object}                           oauthParameters     An object whose keys come from\r\n*                                                               Constants.OAuth2.Parameters\r\n* @param {OAuth2Client.GetTokenCallback}   callback            The callback function.\r\n*/\n\n\nOAuth2Client.prototype.getToken = function (oauthParameters, callback) {\n  var self = this;\n\n  var tokenUrl = self._createTokenUrl();\n\n  var urlEncodedTokenRequestForm = querystring.stringify(oauthParameters);\n\n  var postOptions = self._createPostOption(tokenUrl, urlEncodedTokenRequestForm);\n\n  axios(postOptions).then(response => {\n    util.logReturnCorrelationId(this._log, 'Get Token', response); // status >= 300 && < 400\n\n    if (!util.isHttpSuccess(response.status)) {\n      var returnErrorString = 'Get Token' + ' request returned http error: ' + response.status + ' and server response: ' + JSON.stringify(error.response.data);\n      callback(this._log.createError(returnErrorString, true), response.data);\n    } // Success case: status >= 200 && < 300\n\n\n    self._handleGetTokenResponse(response.data, callback);\n  }).catch(error => {\n    // status >= 400: error case\n    if (error.response) {\n      util.logReturnCorrelationId(this._log, 'Get Token', error.response);\n\n      this._log.error('Get Token' + ' request failed with', error.response.status, true);\n\n      var returnErrorString = 'Get Token' + ' request returned http error: ' + error.response.status + ' and server response: ' + JSON.stringify(error.response.data);\n      callback(self._log.createError(returnErrorString, true), error.response.data);\n    } // if there is no response from the server\n    else if (error.request) {\n        this._log.error('Get Token' + ' request was made but no response was received', error.request, true);\n\n        callback(self._log.createError('No response from the server'));\n      } // request was never made\n      else if (error.message) {\n          this._log.error('Get Token' + ' request was never made, please check', error.message, true);\n\n          callback(error.message);\n        } // unknown error\n        else {\n            self._log.error('GetToken' + ' failed with unknown error', \"unknown error\", true);\n\n            callback(self._log.createError('failed with an unknown error'));\n          }\n  });\n};\n/**\r\n * @param {object}                          oauthParameters     An object whose keys come from\r\n *                                                               Constants.OAuth2.Parameters\r\n * @param {integer}                         refresh_interval    The interval for polling request. \r\n * @param {integer}                         exipres_in          The timeout for polling request. \r\n * @param {OAuth2Client.GetTokenCallback}   callback            The callback function.\r\n */\n\n\nOAuth2Client.prototype.getTokenWithPolling = function (oauthParameters, refresh_interval, expires_in, callback) {\n  var self = this;\n  var maxTimesForRetry = Math.floor(expires_in / refresh_interval);\n\n  var tokenUrl = self._createTokenUrl();\n\n  var urlEncodedTokenRequestForm = querystring.stringify(oauthParameters);\n\n  var postOptions = self._createPostOption(tokenUrl, urlEncodedTokenRequestForm);\n\n  var optionsForRetry = {\n    times: maxTimesForRetry,\n    interval: refresh_interval * 1000\n  };\n  async.retry(optionsForRetry, function (retryCallback, response) {\n    self._getTokenWithPolling(postOptions, retryCallback);\n  }, function (err, response) {\n    if (response && response instanceof Error) {\n      callback(response);\n      return;\n    } else if (response && response.hasOwnProperty(DeviceCodeResponseParameters.ERROR)) {\n      callback(response);\n      return;\n    }\n\n    callback(err, response);\n  });\n};\n\nOAuth2Client.prototype.getUserCodeInfo = function (oauthParameters, callback) {\n  // for now make it as a post request\n  var self = this;\n\n  var deviceCodeUrl = self._createDeviceCodeUrl();\n\n  var urlEncodedDeviceCodeRequestForm = querystring.stringify(oauthParameters);\n\n  var postOptions = self._createPostOption(deviceCodeUrl, urlEncodedDeviceCodeRequestForm);\n\n  axios(postOptions).then(response => {\n    util.logReturnCorrelationId(this._log, 'Get Device Code', response); // status >= 300 && < 400\n\n    if (!util.isHttpSuccess(response.status)) {\n      var returnErrorString = 'Get Device Code' + ' request returned http error: ' + response.status + ' and server response: ' + JSON.stringify(error.response.data);\n      callback(this._log.createError(returnErrorString, true), response.data);\n    } // Success case: status >= 200 && < 300\n\n\n    self._handleGetDeviceCodeResponse(response.data, callback);\n  }).catch(error => {\n    // status >= 400: error case\n    if (error.response) {\n      util.logReturnCorrelationId(this._log, 'Get Device Code', error.response);\n\n      this._log.error('Get Device Code' + ' request failed with', error.response.status, true);\n\n      var returnErrorString = 'Get Device Code' + ' request returned http error: ' + error.response.status + ' and server response: ' + JSON.stringify(error.response.data);\n      callback(self._log.createError(returnErrorString, true), error.response.data);\n    } // if there is no response from the server\n    else if (error.request) {\n        this._log.error('Get Device Code' + ' request was made but no response was received', error.request, true);\n\n        callback(self._log.createError('No response from the server'));\n      } // request was never made\n      else if (error.message) {\n          this._log.error('Get Device Code' + ' request was never made, please check', error.message, true);\n\n          callback(error.message);\n        } // unknown error\n        else {\n            self._log.error('Get Device Code' + ' failed with unknown error', \"unknown error\", true);\n\n            callback(self._log.createError('failed with an unknown error'));\n          }\n  });\n};\n/**\r\n * Cancel the polling request made for acquiring token by device code. \r\n */\n\n\nOAuth2Client.prototype.cancelPollingRequest = function () {\n  this._cancelPollingRequest = true;\n};\n\nmodule.exports = OAuth2Client;","map":{"version":3,"sources":["C:/Users/jesus/Documents/GitHub/Turismo-Real/Front/Pwa/node_modules/adal-node/lib/oauth2client.js"],"names":["_","require","querystring","uuid","axios","url","async","constants","Logger","util","OAuth2Parameters","OAuth2","Parameters","OAuth2ResponseParameters","ResponseParameters","DeviceCodeResponseParameters","IdTokenMap","TokenResponseFields","UserCodeResponseFields","IdTokenFields","TOKEN_RESPONSE_MAP","TOKEN_TYPE","ACCESS_TOKEN","REFRESH_TOKEN","CREATED_ON","EXPIRES_ON","EXPIRES_IN","RESOURCE","ERROR","ERROR_DESCRIPTION","DEVICE_CODE_RESPONSE_MAP","DEVICE_CODE","USER_CODE","VERIFICATION_URL","INTERVAL","MESSAGE","OAuth2Client","callContext","authority","_aadApiVersion","aadApiVersion","undefined","_tokenEndpoint","tokenEndpoint","_deviceCodeEndpoint","deviceCodeEndpoint","_log","_logContext","_callContext","_cancelPollingRequest","prototype","_createTokenUrl","tokenUrl","parse","parameters","AAD_API_VERSION","search","stringify","_createDeviceCodeUrl","deviceCodeUrl","_parseOptionalInts","obj","keys","self","forEach","element","has","parseInt","isNaN","createError","_crackJwt","jwtToken","idTokenPartsRegex","matches","exec","length","warn","crackedToken","header","JWSPayload","JWSSig","_getUserId","idToken","userId","isDisplayable","upn","email","sub","v4","userIdVals","USER_ID","IS_USER_ID_DISPLAYABLE","mapFields","inObj","outObj","map","key","mappedKey","_extractIdTokenValues","extractedValues","extend","_parseIdToken","encodedIdToken","base64IdToken","base64Decoded","base64DecodeStringUrlSafe","JSON","err","stack","_validateTokenResponse","body","wireResponse","tokenResponse","e","Error","intKeys","expiresIn","now","Date","add","seconds","tempDate","createdOn","setTime","ID_TOKEN","_validateDeviceCodeResponse","deviceCodeResponse","_handlePollingResponse","_handlePollingRequestErrorResponse","isEmpty","_handleGetTokenResponse","callback","error","_handleGetDeviceCodeResponse","_getTokenWithPolling","postOptions","then","response","logReturnCorrelationId","data","catch","hasOwnProperty","request","message","_createPostOption","postUrl","urlEncodedRequestForm","createRequestOptions","method","format","headers","maxRedirects","encoding","getToken","oauthParameters","urlEncodedTokenRequestForm","isHttpSuccess","status","returnErrorString","getTokenWithPolling","refresh_interval","expires_in","maxTimesForRetry","Math","floor","optionsForRetry","times","interval","retry","retryCallback","getUserCodeInfo","urlEncodedDeviceCodeRequestForm","cancelPollingRequest","module","exports"],"mappings":"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","sourcesContent":["/*\r\n * @copyright\r\n * Copyright © Microsoft Open Technologies, Inc.\r\n *\r\n * All Rights Reserved\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http: *www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * THIS CODE IS PROVIDED *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS\r\n * OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION\r\n * ANY IMPLIED WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A\r\n * PARTICULAR PURPOSE, MERCHANTABILITY OR NON-INFRINGEMENT.\r\n *\r\n * See the Apache License, Version 2.0 for the specific language\r\n * governing permissions and limitations under the License.\r\n */\r\n'use strict';\r\n\r\nvar _ = require('underscore');\r\nrequire('date-utils');  // Adds a number of convenience methods to the builtin Date object.\r\nvar querystring = require('querystring');\r\nvar uuid = require('uuid');\r\nvar axios = require('axios');\r\nvar url = require('url');\r\nvar async = require('async');\r\n\r\nvar constants = require('./constants');\r\nvar Logger = require('./log').Logger;\r\nvar util = require('./util');\r\n\r\nvar OAuth2Parameters = constants.OAuth2.Parameters;\r\nvar OAuth2ResponseParameters = constants.OAuth2.ResponseParameters;\r\nvar DeviceCodeResponseParameters = constants.OAuth2.DeviceCodeResponseParameters;\r\nvar IdTokenMap = constants.OAuth2.IdTokenMap;\r\nvar TokenResponseFields = constants.TokenResponseFields;\r\nvar UserCodeResponseFields = constants.UserCodeResponseFields;\r\nvar IdTokenFields = constants.IdTokenFields;\r\n\r\nvar TOKEN_RESPONSE_MAP = {};\r\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.TOKEN_TYPE] = TokenResponseFields.TOKEN_TYPE;\r\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.ACCESS_TOKEN] = TokenResponseFields.ACCESS_TOKEN;\r\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.REFRESH_TOKEN] = TokenResponseFields.REFRESH_TOKEN;\r\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.CREATED_ON] = TokenResponseFields.CREATED_ON;\r\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.EXPIRES_ON] = TokenResponseFields.EXPIRES_ON;\r\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.EXPIRES_IN] = TokenResponseFields.EXPIRES_IN;\r\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.RESOURCE] = TokenResponseFields.RESOURCE;\r\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.ERROR] = TokenResponseFields.ERROR;\r\nTOKEN_RESPONSE_MAP[OAuth2ResponseParameters.ERROR_DESCRIPTION] = TokenResponseFields.ERROR_DESCRIPTION;\r\n\r\n\r\nvar DEVICE_CODE_RESPONSE_MAP = {};\r\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.DEVICE_CODE] = UserCodeResponseFields.DEVICE_CODE;\r\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.USER_CODE] = UserCodeResponseFields.USER_CODE;\r\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.VERIFICATION_URL] = UserCodeResponseFields.VERIFICATION_URL;\r\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.INTERVAL] = UserCodeResponseFields.INTERVAL;\r\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.EXPIRES_IN] = UserCodeResponseFields.EXPIRES_IN;\r\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.MESSAGE] = UserCodeResponseFields.MESSAGE;\r\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.ERROR] = UserCodeResponseFields.ERROR;\r\nDEVICE_CODE_RESPONSE_MAP[DeviceCodeResponseParameters.ERROR_DESCRIPTION] = UserCodeResponseFields.ERROR_DESCRIPTION;\r\n\r\n/**\r\n * Constructs an instances of OAuth2Client\r\n * @constructor\r\n * @private\r\n * @param {object} callContext Contains any context information that applies to the request.\r\n * @param {string|url} authority  An url that points to an authority.\r\n */\r\nfunction OAuth2Client(callContext, authority) {\r\n  this._aadApiVersion = authority.aadApiVersion === undefined? '1.0' : authority.aadApiVersion;\r\n  this._tokenEndpoint = authority.tokenEndpoint;\r\n  this._deviceCodeEndpoint = authority.deviceCodeEndpoint;\r\n\r\n  this._log = new Logger('OAuth2Client', callContext._logContext);\r\n  this._callContext = callContext;\r\n  this._cancelPollingRequest = false;\r\n}\r\n\r\n/**\r\n * Constructs an OAuth 2.0 token request url.\r\n * @private\r\n * @return {URL}\r\n */\r\nOAuth2Client.prototype._createTokenUrl = function () {\r\n  var tokenUrl = url.parse(this._tokenEndpoint);\r\n\r\n  var parameters = {};\r\n  parameters[OAuth2Parameters.AAD_API_VERSION] = this._aadApiVersion;\r\n\r\n  tokenUrl.search = querystring.stringify(parameters);\r\n  return tokenUrl;\r\n};\r\n\r\n/**\r\n * Constructs the user code info request url. \r\n * @private \r\n * @return {URL}\r\n */\r\nOAuth2Client.prototype._createDeviceCodeUrl = function () {\r\n   var deviceCodeUrl = url.parse(this._deviceCodeEndpoint);\r\n\r\n   var parameters = {};\r\n   parameters[OAuth2Parameters.AAD_API_VERSION] = this._aadApiVersion;\r\n\r\n   deviceCodeUrl.search = querystring.stringify(parameters);\r\n\r\n   return deviceCodeUrl;\r\n};\r\n\r\n/**\r\n * @private\r\n * @param {object}   obj         An object in which integer values may reside.\r\n * @param {array}    keys        An array of strings that specify keys in which integers may need parsing.\r\n */\r\nOAuth2Client.prototype._parseOptionalInts = function (obj, keys) {\r\n  var self = this;\r\n  keys.forEach(function(element) {\r\n    if (_.has(obj, element)) {\r\n      obj[element] = parseInt(obj[element], 10);\r\n      if (isNaN(obj[element])) {\r\n        throw self._log.createError(element + ' could not be parsed as an int.');\r\n      }\r\n    }\r\n  });\r\n};\r\n\r\n/**\r\n * Parses a JWS encoded JWT into it's three parts.\r\n * @param  {string} jwtToken The token to parse.\r\n * @return {object}          The three JWS parts, header, JWSPayload, and JWSSig, or undefined.\r\n */\r\nOAuth2Client.prototype._crackJwt = function(jwtToken) {\r\n  var idTokenPartsRegex = /^([^\\.\\s]*)\\.([^\\.\\s]+)\\.([^\\.\\s]*)$/;\r\n\r\n  var matches = idTokenPartsRegex.exec(jwtToken);\r\n  if (!matches || matches.length < 4) {\r\n    this._log.warn('The returned id_token is not parseable.');\r\n    return;\r\n  }\r\n\r\n  var crackedToken = {\r\n    header : matches[1],\r\n    JWSPayload : matches[2],\r\n    JWSSig : matches[3]\r\n  };\r\n\r\n  return crackedToken;\r\n};\r\n\r\n/**\r\n * Finds the value that should be used as the userId value.\r\n * @param {object} idToken The id token that parsed.\r\n * @returns {object} An object with a userId field and maybe a userIdIsDisplayable field.\r\n */\r\nOAuth2Client.prototype._getUserId = function(idToken) {\r\n  var userId;\r\n  var isDisplayable;\r\n\r\n  if (idToken.upn) {\r\n    userId = idToken.upn;\r\n    isDisplayable = true;\r\n  } else if (idToken.email) {\r\n    userId = idToken.email;\r\n    isDisplayable = true;\r\n  } else if (idToken.sub) {\r\n    userId = idToken.sub;\r\n  }\r\n\r\n  if (!userId) {\r\n    // generate a random GUID.\r\n    userId = uuid.v4();\r\n  }\r\n\r\n  var userIdVals = {};\r\n  userIdVals[IdTokenFields.USER_ID] = userId;\r\n  if (isDisplayable) {\r\n    userIdVals[IdTokenFields.IS_USER_ID_DISPLAYABLE] = true;\r\n  }\r\n\r\n  return userIdVals;\r\n};\r\n\r\nfunction mapFields(inObj, outObj, map) {\r\n  for (var key in inObj) {\r\n    if (map[key]) {\r\n      var mappedKey = map[key];\r\n      outObj[mappedKey] = inObj[key];\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Given a decoded id token off the wire, this function extracts the values that\r\n * ADAL commonly returns to callers and translates the names to more user\r\n * friendly names.\r\n * @param  {Object} idToken A decoded id token.\r\n * @return {Object}         The set of extracted values with their new names.\r\n */\r\nOAuth2Client.prototype._extractIdTokenValues = function(idToken) {\r\n  var extractedValues = {};\r\n  _.extend(extractedValues, this._getUserId(idToken));\r\n\r\n  mapFields(idToken, extractedValues, IdTokenMap);\r\n\r\n  return extractedValues;\r\n};\r\n\r\n/**\r\n * Parses the value of the id_token OAuth 2 Reponse.\r\n * @param  {string} encodedIdToken An unencrypted JWT token.\r\n * @return {object}                 returns the decoded id_token or undefined.\r\n */\r\nOAuth2Client.prototype._parseIdToken = function(encodedIdToken) {\r\n  var crackedToken = this._crackJwt(encodedIdToken);\r\n  if (!crackedToken) {\r\n    return;\r\n  }\r\n\r\n  var idToken;\r\n  try {\r\n    var base64IdToken = crackedToken.JWSPayload;\r\n    var base64Decoded = util.base64DecodeStringUrlSafe(base64IdToken);\r\n    if (!base64Decoded) {\r\n      this._log.warn('The returned id_token could not be base64 url safe decoded.');\r\n      return;\r\n    }\r\n\r\n    idToken = JSON.parse(base64Decoded);\r\n  } catch (err) {\r\n    this._log.warn('the returned id_token could not be decoded');\r\n    this._log.warn('The returned id_token could not be decoded: ' + err.stack, true);\r\n    return;\r\n  }\r\n\r\n  return this._extractIdTokenValues(idToken);\r\n};\r\n\r\n/**\r\n * Validates the response returned from an OAuth 2.0 token request.\r\n * @private\r\n * @param  {string} body  The response as a string encoded JSON object.\r\n * @return {object}       The parsed response.\r\n */\r\nOAuth2Client.prototype._validateTokenResponse = function (body) {\r\n  var wireResponse;\r\n  var tokenResponse = {};\r\n\r\n  try {\r\n    wireResponse = body;\r\n  } catch(e) {\r\n    throw new Error('The token response returned from the server is unparseable as JSON');\r\n  }\r\n\r\n  var intKeys = [\r\n    OAuth2ResponseParameters.EXPIRES_ON,\r\n    OAuth2ResponseParameters.EXPIRES_IN,\r\n    OAuth2ResponseParameters.CREATED_ON\r\n  ];\r\n\r\n  this._parseOptionalInts(wireResponse, intKeys);\r\n\r\n  if (wireResponse[OAuth2ResponseParameters.EXPIRES_IN]) {\r\n    var expiresIn = wireResponse[OAuth2ResponseParameters.EXPIRES_IN];\r\n    var now = new Date();\r\n    wireResponse[OAuth2ResponseParameters.EXPIRES_ON] = now.add( { seconds : expiresIn });\r\n  }\r\n\r\n  if (wireResponse[OAuth2ResponseParameters.CREATED_ON]) {\r\n    var tempDate = new Date();\r\n    var createdOn = wireResponse[OAuth2ResponseParameters.CREATED_ON];\r\n    tempDate.setTime(createdOn);\r\n    wireResponse[OAuth2ResponseParameters.CREATED_ON] = tempDate;\r\n  }\r\n\r\n  if (!wireResponse[OAuth2ResponseParameters.TOKEN_TYPE]) {\r\n    throw this._log.createError('wireResponse is missing token_type');\r\n  }\r\n  if (!wireResponse[OAuth2ResponseParameters.ACCESS_TOKEN]) {\r\n    throw this._log.createError('wireResponse missing access_token');\r\n  }\r\n  \r\n  mapFields(wireResponse, tokenResponse, TOKEN_RESPONSE_MAP);\r\n\r\n  if (wireResponse[OAuth2ResponseParameters.ID_TOKEN]) {\r\n    var idToken = this._parseIdToken(wireResponse[OAuth2ResponseParameters.ID_TOKEN]);\r\n    if (idToken) {\r\n      _.extend(tokenResponse, idToken);\r\n    }\r\n  }\r\n\r\n  return tokenResponse;\r\n};\r\n\r\n/**\r\n * Validates the response returned from an OAuth 2.0 device code request.\r\n * @private\r\n * @param  {string} body  The response as a string encoded JSON object.\r\n * @return {object}       The parsed response.\r\n */\r\nOAuth2Client.prototype._validateDeviceCodeResponse = function(body) {\r\n   var wireResponse;\r\n   var deviceCodeResponse = {};\r\n\r\n   try {\r\n     wireResponse = body;\r\n   } catch(e) {\r\n      throw new Error('The device code response returned from the server is unparseable as JSON.');\r\n   }\r\n\r\n   var intKeys = [\r\n        DeviceCodeResponseParameters.EXPIRES_IN, \r\n        DeviceCodeResponseParameters.INTERVAL\r\n   ];\r\n\r\n   this._parseOptionalInts(wireResponse, intKeys);\r\n  \r\n   if (!wireResponse[DeviceCodeResponseParameters.EXPIRES_IN]){\r\n      throw this._log.createError('wireResponse is missing expires_in');\r\n   }\r\n\r\n   if (!wireResponse[DeviceCodeResponseParameters.DEVICE_CODE]) {\r\n      throw this._log.createError('wireResponse is missing device code');\r\n   }\r\n\r\n   if (!wireResponse[DeviceCodeResponseParameters.USER_CODE]) {\r\n      throw this._log.createError('wireResponse is missing user code');\r\n   }\r\n\r\n   mapFields(wireResponse, deviceCodeResponse, DEVICE_CODE_RESPONSE_MAP);\r\n\r\n   return deviceCodeResponse;\r\n};\r\n\r\n/**\r\n * @private\r\n * @param {string}                   body        The body of a http token response.\r\n */\r\nOAuth2Client.prototype._handlePollingResponse = function(body) {\r\n    //handle token error response\r\n    var tokenResponse = this._handlePollingRequestErrorResponse(body);\r\n    if (_.isEmpty(tokenResponse)){\r\n       tokenResponse = this._validateTokenResponse(body);\r\n    }\r\n\r\n    return tokenResponse;\r\n};\r\n\r\n/**\r\n * @private\r\n * @param {string}                   body        The body of a http token response.\r\n */\r\nOAuth2Client.prototype._handlePollingRequestErrorResponse = function(body) {\r\n   var wireResponse;\r\n   var tokenResponse = {};\r\n\r\n   try {\r\n     wireResponse = body;\r\n   } catch (e) {\r\n      throw new Error ('The token response returned from the server is unparsable as JSON');\r\n   }\r\n\r\n   if (wireResponse[OAuth2ResponseParameters.ERROR]) {\r\n      mapFields(wireResponse, tokenResponse, TOKEN_RESPONSE_MAP);\r\n   }\r\n\r\n   return tokenResponse;\r\n};\r\n\r\n/**\r\n * @private\r\n * @param {object}                   response    An http response object.\r\n * @param {string}                   body        The body of a http token response.\r\n * @param {OAuth2Client.GetTokenCallback}    callback    A call back function.  The body parameter is the body parameter passed\r\n *                                               into this function.\r\n */\r\nOAuth2Client.prototype._handleGetTokenResponse = function(body, callback) {\r\n  var tokenResponse;\r\n  try {\r\n    tokenResponse = this._validateTokenResponse(body);\r\n  } catch (e) {\r\n    this._log.error('Error validating get token response', e, true);\r\n    callback(e);\r\n    return;\r\n  }\r\n  callback(null, tokenResponse);\r\n};\r\n\r\nOAuth2Client.prototype._handleGetDeviceCodeResponse = function(body, callback) {\r\n   var deviceCodeResponse;\r\n   try {\r\n      deviceCodeResponse = this._validateDeviceCodeResponse(body);\r\n   } catch (e) {\r\n      this._log.error('Error validating get user code response', e, true);\r\n      callback(e);\r\n      return;\r\n   }\r\n\r\n   callback(null, deviceCodeResponse);\r\n};\r\n\r\nOAuth2Client.prototype._getTokenWithPolling = function (postOptions, callback) {\r\n    var self = this;\r\n    if (self._cancelPollingRequest === true) {\r\n        callback(null, new Error('Polling_Request_Cancelled'));\r\n        return;\r\n    }\r\n\r\n    axios(postOptions).then((response) => {\r\n      var tokenResponse;\r\n      util.logReturnCorrelationId(this._log, 'GetToken', response);\r\n      try {\r\n        tokenResponse = self._handlePollingResponse(response.data);\r\n      } catch (e) {\r\n        self._log.error('Error validating get token response', e, true);\r\n        callback(null, e);\r\n        return;\r\n      }\r\n      callback(null, tokenResponse);\r\n    }).catch((error) => {\r\n      // status >= 400: error case\r\n      if (error.response) {\r\n        util.logReturnCorrelationId(this._log, 'GetToken', error.response);\r\n        // error response callback, for error response, it's already parsed as Json. \r\n        if (error.response && error.response.data.hasOwnProperty(TokenResponseFields.ERROR) && error.response.data[TokenResponseFields.ERROR] === 'authorization_pending') {\r\n          callback(new Error(error.response.data[TokenResponseFields.ERROR]), error.response.data);\r\n        }\r\n      }\r\n      // if there is no response from the server\r\n      else if (error.request) {\r\n        self._log.error('GetToken' + ' request was made but no response was received', error.request, true);\r\n        callback(self._log.createError('No response from the server'));\r\n      }\r\n      // request was never made\r\n      else if (error.message) {\r\n        self._log.error('GetToken http get failed.' + ' request was never made, please check', error.message, true);\r\n        callback(error.message);\r\n      }\r\n      // unknown error\r\n      else {\r\n        self._log.error('GetToken' + ' failed with unknown error', \"unknown error\", true);\r\n        callback(self._log.createError('failed with an unknown error'));\r\n      }\r\n    });\r\n};\r\n\r\nOAuth2Client.prototype._createPostOption = function (postUrl, urlEncodedRequestForm) {\r\n  \r\n    var postOptions = util.createRequestOptions(\r\n        this,\r\n      {\r\n            method : 'POST',\r\n            url : url.format(postUrl),\r\n            data : urlEncodedRequestForm,\r\n            headers: {\r\n              'Content-Type': 'application/x-www-form-urlencoded',\r\n            },\r\n            maxRedirects: 0,\r\n            encoding: 'utf8',\r\n        }\r\n    );\r\n   \r\n    return postOptions;\r\n};\r\n\r\n/**\r\n * @callback GetTokenCallback\r\n * @memberOf OAuth2Client\r\n * @param {Error} [error] In case of an error this will hold the associated Error object.\r\n * @param {TokenResponse} tokenResponse Contains the parsed result of a get token request.\r\n */\r\n\r\n/**\r\n* @param {object}                           oauthParameters     An object whose keys come from\r\n*                                                               Constants.OAuth2.Parameters\r\n* @param {OAuth2Client.GetTokenCallback}   callback            The callback function.\r\n*/\r\nOAuth2Client.prototype.getToken = function(oauthParameters, callback) {\r\n  var self = this;\r\n  var tokenUrl = self._createTokenUrl();\r\n\r\n  var urlEncodedTokenRequestForm = querystring.stringify(oauthParameters);\r\n  var postOptions = self._createPostOption(tokenUrl, urlEncodedTokenRequestForm);\r\n\r\n  axios(postOptions).then((response) => {\r\n    util.logReturnCorrelationId(this._log, 'Get Token', response);\r\n    // status >= 300 && < 400\r\n    if (!util.isHttpSuccess(response.status)) {\r\n      var returnErrorString = 'Get Token' + ' request returned http error: ' + response.status + ' and server response: ' + JSON.stringify(error.response.data);\r\n      callback(this._log.createError(returnErrorString, true), response.data);\r\n    }\r\n    // Success case: status >= 200 && < 300\r\n    self._handleGetTokenResponse(response.data, callback);\r\n  }).catch((error) => {\r\n    // status >= 400: error case\r\n    if (error.response) {\r\n      util.logReturnCorrelationId(this._log, 'Get Token', error.response);\r\n      this._log.error('Get Token' + ' request failed with', error.response.status, true);\r\n      var returnErrorString = 'Get Token' + ' request returned http error: ' + error.response.status + ' and server response: ' + JSON.stringify(error.response.data);\r\n      callback(self._log.createError(returnErrorString, true), error.response.data);\r\n    }\r\n    // if there is no response from the server\r\n    else if (error.request) {\r\n      this._log.error('Get Token' + ' request was made but no response was received', error.request, true);\r\n      callback(self._log.createError('No response from the server'));\r\n    }\r\n    // request was never made\r\n    else if (error.message) {\r\n      this._log.error('Get Token' + ' request was never made, please check', error.message, true);\r\n      callback(error.message);\r\n    }\r\n    // unknown error\r\n    else {\r\n      self._log.error('GetToken' + ' failed with unknown error', \"unknown error\", true);\r\n      callback(self._log.createError('failed with an unknown error'));\r\n    }\r\n  });\r\n};\r\n\r\n/**\r\n * @param {object}                          oauthParameters     An object whose keys come from\r\n *                                                               Constants.OAuth2.Parameters\r\n * @param {integer}                         refresh_interval    The interval for polling request. \r\n * @param {integer}                         exipres_in          The timeout for polling request. \r\n * @param {OAuth2Client.GetTokenCallback}   callback            The callback function.\r\n */\r\nOAuth2Client.prototype.getTokenWithPolling = function(oauthParameters, refresh_interval, expires_in, callback){\r\n   var self = this; \r\n   var maxTimesForRetry = Math.floor(expires_in / refresh_interval);\r\n  \r\n   var tokenUrl = self._createTokenUrl();\r\n   var urlEncodedTokenRequestForm = querystring.stringify(oauthParameters);\r\n   var postOptions = self._createPostOption(tokenUrl, urlEncodedTokenRequestForm);\r\n\r\n   var optionsForRetry = {times: maxTimesForRetry, interval: refresh_interval * 1000};\r\n\r\n   async.retry(optionsForRetry, function(retryCallback, response) {\r\n      self._getTokenWithPolling(postOptions, retryCallback);\r\n   }, function(err, response) {\r\n      if (response && response instanceof Error) {\r\n         callback(response);\r\n         return;\r\n      }\r\n      else if (response && response.hasOwnProperty(DeviceCodeResponseParameters.ERROR)) {\r\n         callback(response);\r\n         return;\r\n      }\r\n      callback(err, response);\r\n   });\r\n};\r\n\r\nOAuth2Client.prototype.getUserCodeInfo = function(oauthParameters, callback) {\r\n    // for now make it as a post request\r\n    var self = this;\r\n    var deviceCodeUrl = self._createDeviceCodeUrl();\r\n\r\n    var urlEncodedDeviceCodeRequestForm = querystring.stringify(oauthParameters);\r\n    \r\n    var postOptions = self._createPostOption(deviceCodeUrl, urlEncodedDeviceCodeRequestForm);\r\n  \r\n    axios(postOptions).then((response) => {\r\n      util.logReturnCorrelationId(this._log, 'Get Device Code', response);\r\n      // status >= 300 && < 400\r\n      if (!util.isHttpSuccess(response.status)) {\r\n        var returnErrorString = 'Get Device Code' + ' request returned http error: ' + response.status + ' and server response: ' + JSON.stringify(error.response.data);\r\n        callback(this._log.createError(returnErrorString, true), response.data);\r\n      }\r\n      // Success case: status >= 200 && < 300\r\n      self._handleGetDeviceCodeResponse(response.data, callback);\r\n    }).catch((error) => {\r\n      // status >= 400: error case\r\n      if (error.response) {\r\n      util.logReturnCorrelationId(this._log, 'Get Device Code', error.response);\r\n        this._log.error('Get Device Code' + ' request failed with', error.response.status, true);\r\n        var returnErrorString = 'Get Device Code' + ' request returned http error: ' + error.response.status + ' and server response: ' + JSON.stringify(error.response.data);\r\n        callback(self._log.createError(returnErrorString, true), error.response.data);\r\n      }\r\n      // if there is no response from the server\r\n      else if (error.request) {\r\n        this._log.error('Get Device Code' + ' request was made but no response was received', error.request, true);\r\n        callback(self._log.createError('No response from the server'));\r\n      }\r\n      // request was never made\r\n      else if (error.message) {\r\n        this._log.error('Get Device Code' + ' request was never made, please check', error.message, true);\r\n        callback(error.message);\r\n      }\r\n      // unknown error\r\n      else {\r\n        self._log.error('Get Device Code' + ' failed with unknown error', \"unknown error\", true);\r\n        callback(self._log.createError('failed with an unknown error'));\r\n      }\r\n    });\r\n  };\r\n\r\n/**\r\n * Cancel the polling request made for acquiring token by device code. \r\n */\r\nOAuth2Client.prototype.cancelPollingRequest = function() {\r\n   this._cancelPollingRequest = true;\r\n};\r\n\r\nmodule.exports = OAuth2Client;\r\n"]},"metadata":{},"sourceType":"script"}