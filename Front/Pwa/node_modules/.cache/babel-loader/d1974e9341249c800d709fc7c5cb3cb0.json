{"ast":null,"code":"\"use strict\"; // Copyright (c) Microsoft Corporation. All rights reserved.\n// Licensed under the MIT License. See License.txt in the project root for license information.\n\nvar _slicedToArray = require(\"C:/Users/jesus/Documents/GitHub/Turismo-Real/Front/Pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/slicedToArray\");\n\nvar _createForOfIteratorHelper = require(\"C:/Users/jesus/Documents/GitHub/Turismo-Real/Front/Pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createForOfIteratorHelper\");\n\nvar _regeneratorRuntime = require(\"C:/Users/jesus/Documents/GitHub/Turismo-Real/Front/Pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\");\n\nvar _classCallCheck = require(\"C:/Users/jesus/Documents/GitHub/Turismo-Real/Front/Pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"C:/Users/jesus/Documents/GitHub/Turismo-Real/Front/Pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : new P(function (resolve) {\n        resolve(result.value);\n      }).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar ms_rest_js_1 = require(\"@azure/ms-rest-js\");\n\nvar login_1 = require(\"../login\");\n/**\r\n * Describes the credentials by retrieving token via Azure CLI.\r\n */\n\n\nvar AzureCliCredentials = /*#__PURE__*/function () {\n  function AzureCliCredentials(subscriptionInfo, tokenInfo) {\n    var resource = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : \"https://management.azure.com\";\n\n    _classCallCheck(this, AzureCliCredentials);\n\n    /**\r\n     * Azure resource endpoints.\r\n     * - Defaults to Azure Resource Manager from environment: AzureCloud. \"https://management.azure.com\"\r\n     * - For Azure KeyVault: \"https://vault.azure.net\"\r\n     * - For Azure Batch: \"https://batch.core.windows.net\"\r\n     * - For Azure Active Directory Graph: \"https://graph.windows.net\"\r\n     *\r\n     * To get the resource for other clouds:\r\n     * - `az cloud list`\r\n     */\n    // tslint:disable-next-line: no-inferrable-types\n    this.resource = \"https://management.azure.com\";\n    /**\r\n     * The number of seconds within which it is good to renew the token.\r\n     *  A constant set to 270 seconds (4.5 minutes).\r\n     */\n\n    this._tokenRenewalMarginInSeconds = 270;\n    this.subscriptionInfo = subscriptionInfo;\n    this.tokenInfo = tokenInfo;\n    this.resource = resource;\n  }\n  /**\r\n   * Tries to get the new token from Azure CLI, if the token has expired or the subscription has\r\n   * changed else uses the cached accessToken.\r\n   * @returns The tokenResponse (tokenType and accessToken are the two important properties).\r\n   */\n\n\n  _createClass(AzureCliCredentials, [{\n    key: \"getToken\",\n    value: function getToken() {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n        var result;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                if (!(this._hasTokenExpired() || this._hasSubscriptionChanged() || this._hasResourceChanged())) {\n                  _context.next = 10;\n                  break;\n                }\n\n                _context.prev = 1;\n                _context.next = 4;\n                return AzureCliCredentials.getAccessToken({\n                  subscriptionIdOrName: this.subscriptionInfo.id,\n                  resource: this.resource\n                });\n\n              case 4:\n                this.tokenInfo = _context.sent;\n                _context.next = 10;\n                break;\n\n              case 7:\n                _context.prev = 7;\n                _context.t0 = _context[\"catch\"](1);\n                throw new Error(\"An error occurred while refreshing the new access \" + \"token:\".concat(_context.t0.stderr ? _context.t0.stderr : _context.t0.message));\n\n              case 10:\n                result = {\n                  accessToken: this.tokenInfo.accessToken,\n                  tokenType: this.tokenInfo.tokenType,\n                  expiresOn: this.tokenInfo.expiresOn,\n                  tenantId: this.tokenInfo.tenant\n                };\n                return _context.abrupt(\"return\", result);\n\n              case 12:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this, [[1, 7]]);\n      }));\n    }\n    /**\r\n     * Signs a request with the Authentication header.\r\n     * @param The request to be signed.\r\n     */\n\n  }, {\n    key: \"signRequest\",\n    value: function signRequest(webResource) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n        var tokenResponse;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return this.getToken();\n\n              case 2:\n                tokenResponse = _context2.sent;\n                webResource.headers.set(ms_rest_js_1.Constants.HeaderConstants.AUTHORIZATION, \"\".concat(tokenResponse.tokenType, \" \").concat(tokenResponse.accessToken));\n                return _context2.abrupt(\"return\", webResource);\n\n              case 5:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n    }\n  }, {\n    key: \"_hasTokenExpired\",\n    value: function _hasTokenExpired() {\n      var result = true;\n      var now = Math.floor(Date.now() / 1000);\n\n      if (this.tokenInfo.expiresOn && this.tokenInfo.expiresOn instanceof Date && Math.floor(this.tokenInfo.expiresOn.getTime() / 1000) - now > this._tokenRenewalMarginInSeconds) {\n        result = false;\n      }\n\n      return result;\n    }\n  }, {\n    key: \"_hasSubscriptionChanged\",\n    value: function _hasSubscriptionChanged() {\n      return this.subscriptionInfo.id !== this.tokenInfo.subscription;\n    }\n  }, {\n    key: \"_parseToken\",\n    value: function _parseToken() {\n      try {\n        var base64Url = this.tokenInfo.accessToken.split(\".\")[1];\n        var base64 = decodeURIComponent(Buffer.from(base64Url, \"base64\").toString(\"binary\").split(\"\").map(function (c) {\n          return \"%\" + (\"00\" + c.charCodeAt(0).toString(16)).slice(-2);\n        }).join(\"\"));\n        return JSON.parse(base64);\n      } catch (err) {\n        var msg = \"An error occurred while parsing the access token: \".concat(err.stack);\n        throw new Error(msg);\n      }\n    }\n  }, {\n    key: \"_isAzureResourceManagerEndpoint\",\n    value: function _isAzureResourceManagerEndpoint(newResource, currentResource) {\n      if (newResource.endsWith(\"/\")) newResource = newResource.slice(0, -1);\n      if (currentResource.endsWith(\"/\")) currentResource = currentResource.slice(0, -1);\n      return newResource === \"https://management.core.windows.net\" && currentResource === \"https://management.azure.com\" || newResource === \"https://management.azure.com\" && currentResource === \"https://management.core.windows.net\";\n    }\n  }, {\n    key: \"_hasResourceChanged\",\n    value: function _hasResourceChanged() {\n      var parsedToken = this._parseToken(); // normalize the resource string, since it is possible to\n      // provide a resource without a trailing slash\n\n\n      var currentResource = parsedToken.aud && parsedToken.aud.endsWith(\"/\") ? parsedToken.aud.slice(0, -1) : parsedToken.aud;\n      var newResource = this.resource.endsWith(\"/\") ? this.resource.slice(0, -1) : this.resource;\n      var result = this._isAzureResourceManagerEndpoint(newResource, currentResource) ? false : currentResource !== newResource;\n      return result;\n    }\n    /**\r\n     * Gets the access token for the default or specified subscription.\r\n     * @param options Optional parameters that can be provided to get the access token.\r\n     */\n\n  }], [{\n    key: \"getAccessToken\",\n    value: function getAccessToken() {\n      var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n        var cmdArguments, result, message;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.prev = 0;\n                cmdArguments = [\"account\", \"get-access-token\"];\n\n                if (options.subscriptionIdOrName) {\n                  cmdArguments.push(\"-s\");\n                  cmdArguments.push(options.subscriptionIdOrName);\n                }\n\n                if (options.resource) {\n                  cmdArguments.push(\"--resource\");\n                  cmdArguments.push(options.resource);\n                }\n\n                _context3.next = 6;\n                return login_1.execAz(cmdArguments);\n\n              case 6:\n                result = _context3.sent;\n                result.expiresOn = new Date(result.expiresOn);\n                return _context3.abrupt(\"return\", result);\n\n              case 11:\n                _context3.prev = 11;\n                _context3.t0 = _context3[\"catch\"](0);\n                message = \"An error occurred while getting credentials from \" + \"Azure CLI: \".concat(_context3.t0.stack);\n                throw new Error(message);\n\n              case 15:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, null, [[0, 11]]);\n      }));\n    }\n    /**\r\n     * Gets the subscription from Azure CLI.\r\n     * @param subscriptionIdOrName - The name or id of the subscription for which the information is\r\n     * required.\r\n     */\n\n  }, {\n    key: \"getSubscription\",\n    value: function getSubscription(subscriptionIdOrName) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n        var cmdArguments, result, message;\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                if (!(subscriptionIdOrName && (typeof subscriptionIdOrName !== \"string\" || !subscriptionIdOrName.length))) {\n                  _context4.next = 2;\n                  break;\n                }\n\n                throw new Error(\"'subscriptionIdOrName' must be a non-empty string.\");\n\n              case 2:\n                _context4.prev = 2;\n                cmdArguments = [\"account\", \"show\"];\n\n                if (subscriptionIdOrName) {\n                  cmdArguments.push(\"-s\");\n                  cmdArguments.push(subscriptionIdOrName);\n                }\n\n                _context4.next = 7;\n                return login_1.execAz(cmdArguments);\n\n              case 7:\n                result = _context4.sent;\n                return _context4.abrupt(\"return\", result);\n\n              case 11:\n                _context4.prev = 11;\n                _context4.t0 = _context4[\"catch\"](2);\n                message = \"An error occurred while getting information about the current subscription from \" + \"Azure CLI: \".concat(_context4.t0.stack);\n                throw new Error(message);\n\n              case 15:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, null, [[2, 11]]);\n      }));\n    }\n    /**\r\n     * Sets the specified subscription as the default subscription for Azure CLI.\r\n     * @param subscriptionIdOrName The name or id of the subsciption that needs to be set as the\r\n     * default subscription.\r\n     */\n\n  }, {\n    key: \"setDefaultSubscription\",\n    value: function setDefaultSubscription(subscriptionIdOrName) {\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee5() {\n        var message;\n        return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                _context5.prev = 0;\n                _context5.next = 3;\n                return login_1.execAz([\"account\", \"set\", \"-s\", subscriptionIdOrName]);\n\n              case 3:\n                _context5.next = 9;\n                break;\n\n              case 5:\n                _context5.prev = 5;\n                _context5.t0 = _context5[\"catch\"](0);\n                message = \"An error occurred while setting the current subscription from \" + \"Azure CLI: \".concat(_context5.t0.stack);\n                throw new Error(message);\n\n              case 9:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, null, [[0, 5]]);\n      }));\n    }\n    /**\r\n     * Returns a list of all the subscriptions from Azure CLI.\r\n     * @param options Optional parameters that can be provided while listing all the subcriptions.\r\n     */\n\n  }, {\n    key: \"listAllSubscriptions\",\n    value: function listAllSubscriptions() {\n      var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee6() {\n        var subscriptionList, cmdArguments, _iterator, _step, sub, message;\n\n        return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                subscriptionList = [];\n                _context6.prev = 1;\n                cmdArguments = [\"account\", \"list\"];\n\n                if (options.all) {\n                  cmdArguments.push(\" --all\");\n                }\n\n                if (options.refresh) {\n                  cmdArguments.push(\"--refresh\");\n                }\n\n                _context6.next = 7;\n                return login_1.execAz(cmdArguments);\n\n              case 7:\n                subscriptionList = _context6.sent;\n\n                if (subscriptionList && subscriptionList.length) {\n                  _iterator = _createForOfIteratorHelper(subscriptionList);\n\n                  try {\n                    for (_iterator.s(); !(_step = _iterator.n()).done;) {\n                      sub = _step.value;\n\n                      if (sub.cloudName) {\n                        sub.environmentName = sub.cloudName;\n                        delete sub.cloudName;\n                      }\n                    }\n                  } catch (err) {\n                    _iterator.e(err);\n                  } finally {\n                    _iterator.f();\n                  }\n                }\n\n                return _context6.abrupt(\"return\", subscriptionList);\n\n              case 12:\n                _context6.prev = 12;\n                _context6.t0 = _context6[\"catch\"](1);\n                message = \"An error occurred while getting a list of all the subscription from \" + \"Azure CLI: \".concat(_context6.t0.stack);\n                throw new Error(message);\n\n              case 16:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, null, [[1, 12]]);\n      }));\n    }\n    /**\r\n     * Provides credentials that can be used by the JS SDK to interact with Azure via azure cli.\r\n     * **Pre-requisite**\r\n     * - **install azure-cli** . For more information see\r\n     * {@link https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest Install Azure CLI}\r\n     * - **login via `az login`**\r\n     * @param options - Optional parameters that can be provided while creating AzureCliCredentials.\r\n     */\n\n  }, {\n    key: \"create\",\n    value: function create() {\n      var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee7() {\n        var _yield$Promise$all, _yield$Promise$all2, subscriptinInfo, accessToken;\n\n        return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                _context7.next = 2;\n                return Promise.all([AzureCliCredentials.getSubscription(options.subscriptionIdOrName), AzureCliCredentials.getAccessToken(options)]);\n\n              case 2:\n                _yield$Promise$all = _context7.sent;\n                _yield$Promise$all2 = _slicedToArray(_yield$Promise$all, 2);\n                subscriptinInfo = _yield$Promise$all2[0];\n                accessToken = _yield$Promise$all2[1];\n                return _context7.abrupt(\"return\", new AzureCliCredentials(subscriptinInfo, accessToken, options.resource));\n\n              case 7:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7);\n      }));\n    }\n  }]);\n\n  return AzureCliCredentials;\n}();\n\nexports.AzureCliCredentials = AzureCliCredentials;","map":{"version":3,"sources":["../../../lib/credentials/azureCliCredentials.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\r\n// Copyright (c) Microsoft Corporation. All rights reserved.\r\n// Licensed under the MIT License. See License.txt in the project root for license information.\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nconst ms_rest_js_1 = require(\"@azure/ms-rest-js\");\r\nconst login_1 = require(\"../login\");\r\n/**\r\n * Describes the credentials by retrieving token via Azure CLI.\r\n */\r\nclass AzureCliCredentials {\r\n    constructor(subscriptionInfo, tokenInfo, \r\n    // tslint:disable-next-line: no-inferrable-types\r\n    resource = \"https://management.azure.com\") {\r\n        /**\r\n         * Azure resource endpoints.\r\n         * - Defaults to Azure Resource Manager from environment: AzureCloud. \"https://management.azure.com\"\r\n         * - For Azure KeyVault: \"https://vault.azure.net\"\r\n         * - For Azure Batch: \"https://batch.core.windows.net\"\r\n         * - For Azure Active Directory Graph: \"https://graph.windows.net\"\r\n         *\r\n         * To get the resource for other clouds:\r\n         * - `az cloud list`\r\n         */\r\n        // tslint:disable-next-line: no-inferrable-types\r\n        this.resource = \"https://management.azure.com\";\r\n        /**\r\n         * The number of seconds within which it is good to renew the token.\r\n         *  A constant set to 270 seconds (4.5 minutes).\r\n         */\r\n        this._tokenRenewalMarginInSeconds = 270;\r\n        this.subscriptionInfo = subscriptionInfo;\r\n        this.tokenInfo = tokenInfo;\r\n        this.resource = resource;\r\n    }\r\n    /**\r\n     * Tries to get the new token from Azure CLI, if the token has expired or the subscription has\r\n     * changed else uses the cached accessToken.\r\n     * @returns The tokenResponse (tokenType and accessToken are the two important properties).\r\n     */\r\n    getToken() {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            if (this._hasTokenExpired() || this._hasSubscriptionChanged() || this._hasResourceChanged()) {\r\n                try {\r\n                    // refresh the access token\r\n                    this.tokenInfo = yield AzureCliCredentials.getAccessToken({\r\n                        subscriptionIdOrName: this.subscriptionInfo.id,\r\n                        resource: this.resource\r\n                    });\r\n                }\r\n                catch (err) {\r\n                    throw new Error(`An error occurred while refreshing the new access ` +\r\n                        `token:${err.stderr ? err.stderr : err.message}`);\r\n                }\r\n            }\r\n            const result = {\r\n                accessToken: this.tokenInfo.accessToken,\r\n                tokenType: this.tokenInfo.tokenType,\r\n                expiresOn: this.tokenInfo.expiresOn,\r\n                tenantId: this.tokenInfo.tenant\r\n            };\r\n            return result;\r\n        });\r\n    }\r\n    /**\r\n     * Signs a request with the Authentication header.\r\n     * @param The request to be signed.\r\n     */\r\n    signRequest(webResource) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            const tokenResponse = yield this.getToken();\r\n            webResource.headers.set(ms_rest_js_1.Constants.HeaderConstants.AUTHORIZATION, `${tokenResponse.tokenType} ${tokenResponse.accessToken}`);\r\n            return webResource;\r\n        });\r\n    }\r\n    _hasTokenExpired() {\r\n        let result = true;\r\n        const now = Math.floor(Date.now() / 1000);\r\n        if (this.tokenInfo.expiresOn &&\r\n            this.tokenInfo.expiresOn instanceof Date &&\r\n            Math.floor(this.tokenInfo.expiresOn.getTime() / 1000) - now >\r\n                this._tokenRenewalMarginInSeconds) {\r\n            result = false;\r\n        }\r\n        return result;\r\n    }\r\n    _hasSubscriptionChanged() {\r\n        return this.subscriptionInfo.id !== this.tokenInfo.subscription;\r\n    }\r\n    _parseToken() {\r\n        try {\r\n            const base64Url = this.tokenInfo.accessToken.split(\".\")[1];\r\n            const base64 = decodeURIComponent(Buffer.from(base64Url, \"base64\")\r\n                .toString(\"binary\")\r\n                .split(\"\")\r\n                .map((c) => {\r\n                return \"%\" + (\"00\" + c.charCodeAt(0).toString(16)).slice(-2);\r\n            })\r\n                .join(\"\"));\r\n            return JSON.parse(base64);\r\n        }\r\n        catch (err) {\r\n            const msg = `An error occurred while parsing the access token: ${err.stack}`;\r\n            throw new Error(msg);\r\n        }\r\n    }\r\n    _isAzureResourceManagerEndpoint(newResource, currentResource) {\r\n        if (newResource.endsWith(\"/\"))\r\n            newResource = newResource.slice(0, -1);\r\n        if (currentResource.endsWith(\"/\"))\r\n            currentResource = currentResource.slice(0, -1);\r\n        return ((newResource === \"https://management.core.windows.net\" &&\r\n            currentResource === \"https://management.azure.com\") ||\r\n            (newResource === \"https://management.azure.com\" &&\r\n                currentResource === \"https://management.core.windows.net\"));\r\n    }\r\n    _hasResourceChanged() {\r\n        const parsedToken = this._parseToken();\r\n        // normalize the resource string, since it is possible to\r\n        // provide a resource without a trailing slash\r\n        const currentResource = parsedToken.aud && parsedToken.aud.endsWith(\"/\")\r\n            ? parsedToken.aud.slice(0, -1)\r\n            : parsedToken.aud;\r\n        const newResource = this.resource.endsWith(\"/\") ? this.resource.slice(0, -1) : this.resource;\r\n        const result = this._isAzureResourceManagerEndpoint(newResource, currentResource)\r\n            ? false\r\n            : currentResource !== newResource;\r\n        return result;\r\n    }\r\n    /**\r\n     * Gets the access token for the default or specified subscription.\r\n     * @param options Optional parameters that can be provided to get the access token.\r\n     */\r\n    static getAccessToken(options = {}) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            try {\r\n                const cmdArguments = [\"account\", \"get-access-token\"];\r\n                if (options.subscriptionIdOrName) {\r\n                    cmdArguments.push(\"-s\");\r\n                    cmdArguments.push(options.subscriptionIdOrName);\r\n                }\r\n                if (options.resource) {\r\n                    cmdArguments.push(\"--resource\");\r\n                    cmdArguments.push(options.resource);\r\n                }\r\n                const result = yield login_1.execAz(cmdArguments);\r\n                result.expiresOn = new Date(result.expiresOn);\r\n                return result;\r\n            }\r\n            catch (err) {\r\n                const message = `An error occurred while getting credentials from ` + `Azure CLI: ${err.stack}`;\r\n                throw new Error(message);\r\n            }\r\n        });\r\n    }\r\n    /**\r\n     * Gets the subscription from Azure CLI.\r\n     * @param subscriptionIdOrName - The name or id of the subscription for which the information is\r\n     * required.\r\n     */\r\n    static getSubscription(subscriptionIdOrName) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            if (subscriptionIdOrName &&\r\n                (typeof subscriptionIdOrName !== \"string\" || !subscriptionIdOrName.length)) {\r\n                throw new Error(\"'subscriptionIdOrName' must be a non-empty string.\");\r\n            }\r\n            try {\r\n                const cmdArguments = [\"account\", \"show\"];\r\n                if (subscriptionIdOrName) {\r\n                    cmdArguments.push(\"-s\");\r\n                    cmdArguments.push(subscriptionIdOrName);\r\n                }\r\n                const result = yield login_1.execAz(cmdArguments);\r\n                return result;\r\n            }\r\n            catch (err) {\r\n                const message = `An error occurred while getting information about the current subscription from ` +\r\n                    `Azure CLI: ${err.stack}`;\r\n                throw new Error(message);\r\n            }\r\n        });\r\n    }\r\n    /**\r\n     * Sets the specified subscription as the default subscription for Azure CLI.\r\n     * @param subscriptionIdOrName The name or id of the subsciption that needs to be set as the\r\n     * default subscription.\r\n     */\r\n    static setDefaultSubscription(subscriptionIdOrName) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            try {\r\n                yield login_1.execAz([\"account\", \"set\", \"-s\", subscriptionIdOrName]);\r\n            }\r\n            catch (err) {\r\n                const message = `An error occurred while setting the current subscription from ` +\r\n                    `Azure CLI: ${err.stack}`;\r\n                throw new Error(message);\r\n            }\r\n        });\r\n    }\r\n    /**\r\n     * Returns a list of all the subscriptions from Azure CLI.\r\n     * @param options Optional parameters that can be provided while listing all the subcriptions.\r\n     */\r\n    static listAllSubscriptions(options = {}) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            let subscriptionList = [];\r\n            try {\r\n                const cmdArguments = [\"account\", \"list\"];\r\n                if (options.all) {\r\n                    cmdArguments.push(\" --all\");\r\n                }\r\n                if (options.refresh) {\r\n                    cmdArguments.push(\"--refresh\");\r\n                }\r\n                subscriptionList = yield login_1.execAz(cmdArguments);\r\n                if (subscriptionList && subscriptionList.length) {\r\n                    for (const sub of subscriptionList) {\r\n                        if (sub.cloudName) {\r\n                            sub.environmentName = sub.cloudName;\r\n                            delete sub.cloudName;\r\n                        }\r\n                    }\r\n                }\r\n                return subscriptionList;\r\n            }\r\n            catch (err) {\r\n                const message = `An error occurred while getting a list of all the subscription from ` +\r\n                    `Azure CLI: ${err.stack}`;\r\n                throw new Error(message);\r\n            }\r\n        });\r\n    }\r\n    /**\r\n     * Provides credentials that can be used by the JS SDK to interact with Azure via azure cli.\r\n     * **Pre-requisite**\r\n     * - **install azure-cli** . For more information see\r\n     * {@link https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest Install Azure CLI}\r\n     * - **login via `az login`**\r\n     * @param options - Optional parameters that can be provided while creating AzureCliCredentials.\r\n     */\r\n    static create(options = {}) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            const [subscriptinInfo, accessToken] = yield Promise.all([\r\n                AzureCliCredentials.getSubscription(options.subscriptionIdOrName),\r\n                AzureCliCredentials.getAccessToken(options)\r\n            ]);\r\n            return new AzureCliCredentials(subscriptinInfo, accessToken, options.resource);\r\n        });\r\n    }\r\n}\r\nexports.AzureCliCredentials = AzureCliCredentials;\r\n//# sourceMappingURL=azureCliCredentials.js.map"]},"metadata":{},"sourceType":"script"}