{"ast":null,"code":"'use strict';\n\nconst debug = require('debug')('mssql:base');\n\nconst {\n  EventEmitter\n} = require('events');\n\nconst {\n  IDS\n} = require('../utils');\n\nconst globalConnection = require('../global-connection');\n\nconst {\n  TransactionError\n} = require('../error');\n\nconst shared = require('../shared');\n\nconst ISOLATION_LEVEL = require('../isolationlevel');\n/**\n * Class Transaction.\n *\n * @property {Number} isolationLevel Controls the locking and row versioning behavior of TSQL statements issued by a connection. READ_COMMITTED by default.\n * @property {String} name Transaction name. Empty string by default.\n *\n * @fires Transaction#begin\n * @fires Transaction#commit\n * @fires Transaction#rollback\n */\n\n\nclass Transaction extends EventEmitter {\n  /**\n   * Create new Transaction.\n   *\n   * @param {Connection} [parent] If ommited, global connection is used instead.\n   */\n  constructor(parent) {\n    super();\n    IDS.add(this, 'Transaction');\n    debug('transaction(%d): created', IDS.get(this));\n    this.parent = parent || globalConnection.pool;\n    this.isolationLevel = Transaction.defaultIsolationLevel;\n    this.name = '';\n  }\n\n  get config() {\n    return this.parent.config;\n  }\n\n  get connected() {\n    return this.parent.connected;\n  }\n  /**\n   * Acquire connection from connection pool.\n   *\n   * @param {Request} request Request.\n   * @param {ConnectionPool~acquireCallback} [callback] A callback which is called after connection has established, or an error has occurred. If omited, method returns Promise.\n   * @return {Transaction|Promise}\n   */\n\n\n  acquire(request, callback) {\n    if (!this._acquiredConnection) {\n      setImmediate(callback, new TransactionError('Transaction has not begun. Call begin() first.', 'ENOTBEGUN'));\n      return this;\n    }\n\n    if (this._activeRequest) {\n      setImmediate(callback, new TransactionError(\"Can't acquire connection for the request. There is another request in progress.\", 'EREQINPROG'));\n      return this;\n    }\n\n    this._activeRequest = request;\n    setImmediate(callback, null, this._acquiredConnection, this._acquiredConfig);\n    return this;\n  }\n  /**\n   * Release connection back to the pool.\n   *\n   * @param {Connection} connection Previously acquired connection.\n   * @return {Transaction}\n   */\n\n\n  release(connection) {\n    if (connection === this._acquiredConnection) {\n      this._activeRequest = null;\n    }\n\n    return this;\n  }\n  /**\n   * Begin a transaction.\n   *\n   * @param {Number} [isolationLevel] Controls the locking and row versioning behavior of TSQL statements issued by a connection.\n   * @param {basicCallback} [callback] A callback which is called after transaction has began, or an error has occurred. If omited, method returns Promise.\n   * @return {Transaction|Promise}\n   */\n\n\n  begin(isolationLevel, callback) {\n    if (isolationLevel instanceof Function) {\n      callback = isolationLevel;\n      isolationLevel = undefined;\n    }\n\n    if (typeof callback === 'function') {\n      this._begin(isolationLevel, err => {\n        if (!err) {\n          this.emit('begin');\n        }\n\n        callback(err);\n      });\n\n      return this;\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      this._begin(isolationLevel, err => {\n        if (err) return reject(err);\n        this.emit('begin');\n        resolve(this);\n      });\n    });\n  }\n  /**\n   * @private\n   * @param {Number} [isolationLevel]\n   * @param {basicCallback} [callback]\n   * @return {Transaction}\n   */\n\n\n  _begin(isolationLevel, callback) {\n    if (this._acquiredConnection) {\n      return setImmediate(callback, new TransactionError('Transaction has already begun.', 'EALREADYBEGUN'));\n    }\n\n    this._aborted = false;\n    this._rollbackRequested = false;\n\n    if (isolationLevel) {\n      if (Object.keys(ISOLATION_LEVEL).some(key => {\n        return ISOLATION_LEVEL[key] === isolationLevel;\n      })) {\n        this.isolationLevel = isolationLevel;\n      } else {\n        throw new TransactionError('Invalid isolation level.');\n      }\n    }\n\n    setImmediate(callback);\n  }\n  /**\n   * Commit a transaction.\n   *\n   * @param {basicCallback} [callback] A callback which is called after transaction has commited, or an error has occurred. If omited, method returns Promise.\n   * @return {Transaction|Promise}\n   */\n\n\n  commit(callback) {\n    if (typeof callback === 'function') {\n      this._commit(err => {\n        if (!err) {\n          this.emit('commit');\n        }\n\n        callback(err);\n      });\n\n      return this;\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      this._commit(err => {\n        if (err) return reject(err);\n        this.emit('commit');\n        resolve();\n      });\n    });\n  }\n  /**\n   * @private\n   * @param {basicCallback} [callback]\n   * @return {Transaction}\n   */\n\n\n  _commit(callback) {\n    if (this._aborted) {\n      return setImmediate(callback, new TransactionError('Transaction has been aborted.', 'EABORT'));\n    }\n\n    if (!this._acquiredConnection) {\n      return setImmediate(callback, new TransactionError('Transaction has not begun. Call begin() first.', 'ENOTBEGUN'));\n    }\n\n    if (this._activeRequest) {\n      return setImmediate(callback, new TransactionError(\"Can't commit transaction. There is a request in progress.\", 'EREQINPROG'));\n    }\n\n    setImmediate(callback);\n  }\n  /**\n   * Returns new request using this transaction.\n   *\n   * @return {Request}\n   */\n\n\n  request() {\n    return new shared.driver.Request(this);\n  }\n  /**\n   * Rollback a transaction.\n   *\n   * @param {basicCallback} [callback] A callback which is called after transaction has rolled back, or an error has occurred. If omited, method returns Promise.\n   * @return {Transaction|Promise}\n   */\n\n\n  rollback(callback) {\n    if (typeof callback === 'function') {\n      this._rollback(err => {\n        if (!err) {\n          this.emit('rollback', this._aborted);\n        }\n\n        callback(err);\n      });\n\n      return this;\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      return this._rollback(err => {\n        if (err) return reject(err);\n        this.emit('rollback', this._aborted);\n        resolve();\n      });\n    });\n  }\n  /**\n   * @private\n   * @param {basicCallback} [callback]\n   * @return {Transaction}\n   */\n\n\n  _rollback(callback) {\n    if (this._aborted) {\n      return setImmediate(callback, new TransactionError('Transaction has been aborted.', 'EABORT'));\n    }\n\n    if (!this._acquiredConnection) {\n      return setImmediate(callback, new TransactionError('Transaction has not begun. Call begin() first.', 'ENOTBEGUN'));\n    }\n\n    if (this._activeRequest) {\n      return setImmediate(callback, new TransactionError(\"Can't rollback transaction. There is a request in progress.\", 'EREQINPROG'));\n    }\n\n    this._rollbackRequested = true;\n    setImmediate(callback);\n  }\n\n}\n/**\n * Default isolation level used for any transactions that don't explicitly specify an isolation level.\n *\n * @type {number}\n */\n\n\nTransaction.defaultIsolationLevel = ISOLATION_LEVEL.READ_COMMITTED;\nmodule.exports = Transaction;","map":{"version":3,"sources":["C:/Users/matia/Documents/Git/Turismo-Real/front/pwa/node_modules/mssql/lib/base/transaction.js"],"names":["debug","require","EventEmitter","IDS","globalConnection","TransactionError","shared","ISOLATION_LEVEL","Transaction","constructor","parent","add","get","pool","isolationLevel","defaultIsolationLevel","name","config","connected","acquire","request","callback","_acquiredConnection","setImmediate","_activeRequest","_acquiredConfig","release","connection","begin","Function","undefined","_begin","err","emit","Promise","resolve","reject","_aborted","_rollbackRequested","Object","keys","some","key","commit","_commit","driver","Request","rollback","_rollback","READ_COMMITTED","module","exports"],"mappings":"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","sourcesContent":["'use strict'\n\nconst debug = require('debug')('mssql:base')\nconst { EventEmitter } = require('events')\nconst { IDS } = require('../utils')\nconst globalConnection = require('../global-connection')\nconst { TransactionError } = require('../error')\nconst shared = require('../shared')\nconst ISOLATION_LEVEL = require('../isolationlevel')\n\n/**\n * Class Transaction.\n *\n * @property {Number} isolationLevel Controls the locking and row versioning behavior of TSQL statements issued by a connection. READ_COMMITTED by default.\n * @property {String} name Transaction name. Empty string by default.\n *\n * @fires Transaction#begin\n * @fires Transaction#commit\n * @fires Transaction#rollback\n */\n\nclass Transaction extends EventEmitter {\n  /**\n   * Create new Transaction.\n   *\n   * @param {Connection} [parent] If ommited, global connection is used instead.\n   */\n\n  constructor (parent) {\n    super()\n\n    IDS.add(this, 'Transaction')\n    debug('transaction(%d): created', IDS.get(this))\n\n    this.parent = parent || globalConnection.pool\n    this.isolationLevel = Transaction.defaultIsolationLevel\n    this.name = ''\n  }\n\n  get config () {\n    return this.parent.config\n  }\n\n  get connected () {\n    return this.parent.connected\n  }\n\n  /**\n   * Acquire connection from connection pool.\n   *\n   * @param {Request} request Request.\n   * @param {ConnectionPool~acquireCallback} [callback] A callback which is called after connection has established, or an error has occurred. If omited, method returns Promise.\n   * @return {Transaction|Promise}\n   */\n\n  acquire (request, callback) {\n    if (!this._acquiredConnection) {\n      setImmediate(callback, new TransactionError('Transaction has not begun. Call begin() first.', 'ENOTBEGUN'))\n      return this\n    }\n\n    if (this._activeRequest) {\n      setImmediate(callback, new TransactionError(\"Can't acquire connection for the request. There is another request in progress.\", 'EREQINPROG'))\n      return this\n    }\n\n    this._activeRequest = request\n    setImmediate(callback, null, this._acquiredConnection, this._acquiredConfig)\n    return this\n  }\n\n  /**\n   * Release connection back to the pool.\n   *\n   * @param {Connection} connection Previously acquired connection.\n   * @return {Transaction}\n   */\n\n  release (connection) {\n    if (connection === this._acquiredConnection) {\n      this._activeRequest = null\n    }\n\n    return this\n  }\n\n  /**\n   * Begin a transaction.\n   *\n   * @param {Number} [isolationLevel] Controls the locking and row versioning behavior of TSQL statements issued by a connection.\n   * @param {basicCallback} [callback] A callback which is called after transaction has began, or an error has occurred. If omited, method returns Promise.\n   * @return {Transaction|Promise}\n   */\n\n  begin (isolationLevel, callback) {\n    if (isolationLevel instanceof Function) {\n      callback = isolationLevel\n      isolationLevel = undefined\n    }\n\n    if (typeof callback === 'function') {\n      this._begin(isolationLevel, err => {\n        if (!err) {\n          this.emit('begin')\n        }\n        callback(err)\n      })\n      return this\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      this._begin(isolationLevel, err => {\n        if (err) return reject(err)\n        this.emit('begin')\n        resolve(this)\n      })\n    })\n  }\n\n  /**\n   * @private\n   * @param {Number} [isolationLevel]\n   * @param {basicCallback} [callback]\n   * @return {Transaction}\n   */\n\n  _begin (isolationLevel, callback) {\n    if (this._acquiredConnection) {\n      return setImmediate(callback, new TransactionError('Transaction has already begun.', 'EALREADYBEGUN'))\n    }\n\n    this._aborted = false\n    this._rollbackRequested = false\n    if (isolationLevel) {\n      if (Object.keys(ISOLATION_LEVEL).some(key => {\n        return ISOLATION_LEVEL[key] === isolationLevel\n      })) {\n        this.isolationLevel = isolationLevel\n      } else {\n        throw new TransactionError('Invalid isolation level.')\n      }\n    }\n\n    setImmediate(callback)\n  }\n\n  /**\n   * Commit a transaction.\n   *\n   * @param {basicCallback} [callback] A callback which is called after transaction has commited, or an error has occurred. If omited, method returns Promise.\n   * @return {Transaction|Promise}\n   */\n\n  commit (callback) {\n    if (typeof callback === 'function') {\n      this._commit(err => {\n        if (!err) {\n          this.emit('commit')\n        }\n        callback(err)\n      })\n      return this\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      this._commit(err => {\n        if (err) return reject(err)\n        this.emit('commit')\n        resolve()\n      })\n    })\n  }\n\n  /**\n   * @private\n   * @param {basicCallback} [callback]\n   * @return {Transaction}\n   */\n\n  _commit (callback) {\n    if (this._aborted) {\n      return setImmediate(callback, new TransactionError('Transaction has been aborted.', 'EABORT'))\n    }\n\n    if (!this._acquiredConnection) {\n      return setImmediate(callback, new TransactionError('Transaction has not begun. Call begin() first.', 'ENOTBEGUN'))\n    }\n\n    if (this._activeRequest) {\n      return setImmediate(callback, new TransactionError(\"Can't commit transaction. There is a request in progress.\", 'EREQINPROG'))\n    }\n\n    setImmediate(callback)\n  }\n\n  /**\n   * Returns new request using this transaction.\n   *\n   * @return {Request}\n   */\n\n  request () {\n    return new shared.driver.Request(this)\n  }\n\n  /**\n   * Rollback a transaction.\n   *\n   * @param {basicCallback} [callback] A callback which is called after transaction has rolled back, or an error has occurred. If omited, method returns Promise.\n   * @return {Transaction|Promise}\n   */\n\n  rollback (callback) {\n    if (typeof callback === 'function') {\n      this._rollback(err => {\n        if (!err) {\n          this.emit('rollback', this._aborted)\n        }\n        callback(err)\n      })\n      return this\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      return this._rollback(err => {\n        if (err) return reject(err)\n        this.emit('rollback', this._aborted)\n        resolve()\n      })\n    })\n  }\n\n  /**\n   * @private\n   * @param {basicCallback} [callback]\n   * @return {Transaction}\n   */\n\n  _rollback (callback) {\n    if (this._aborted) {\n      return setImmediate(callback, new TransactionError('Transaction has been aborted.', 'EABORT'))\n    }\n\n    if (!this._acquiredConnection) {\n      return setImmediate(callback, new TransactionError('Transaction has not begun. Call begin() first.', 'ENOTBEGUN'))\n    }\n\n    if (this._activeRequest) {\n      return setImmediate(callback, new TransactionError(\"Can't rollback transaction. There is a request in progress.\", 'EREQINPROG'))\n    }\n\n    this._rollbackRequested = true\n\n    setImmediate(callback)\n  }\n}\n\n/**\n * Default isolation level used for any transactions that don't explicitly specify an isolation level.\n *\n * @type {number}\n */\nTransaction.defaultIsolationLevel = ISOLATION_LEVEL.READ_COMMITTED\n\nmodule.exports = Transaction\n"]},"metadata":{},"sourceType":"script"}