{"ast":null,"code":"'use strict';\n\nconst debug = require('debug')('mssql:base');\n\nconst {\n  EventEmitter\n} = require('events');\n\nconst {\n  IDS,\n  objectHasProperty\n} = require('../utils');\n\nconst globalConnection = require('../global-connection');\n\nconst {\n  TransactionError,\n  PreparedStatementError\n} = require('../error');\n\nconst shared = require('../shared');\n\nconst {\n  TYPES,\n  declare\n} = require('../datatypes');\n/**\n * Class PreparedStatement.\n *\n * IMPORTANT: Rememeber that each prepared statement means one reserved connection from the pool. Don't forget to unprepare a prepared statement!\n *\n * @property {String} statement Prepared SQL statement.\n */\n\n\nclass PreparedStatement extends EventEmitter {\n  /**\n   * Creates a new Prepared Statement.\n   *\n   * @param {ConnectionPool|Transaction} [holder]\n   */\n  constructor(parent) {\n    super();\n    IDS.add(this, 'PreparedStatement');\n    debug('ps(%d): created', IDS.get(this));\n    this.parent = parent || globalConnection.pool;\n    this._handle = 0;\n    this.prepared = false;\n    this.parameters = {};\n  }\n\n  get config() {\n    return this.parent.config;\n  }\n\n  get connected() {\n    return this.parent.connected;\n  }\n  /**\n   * Acquire connection from connection pool.\n   *\n   * @param {Request} request Request.\n   * @param {ConnectionPool~acquireCallback} [callback] A callback which is called after connection has established, or an error has occurred. If omited, method returns Promise.\n   * @return {PreparedStatement|Promise}\n   */\n\n\n  acquire(request, callback) {\n    if (!this._acquiredConnection) {\n      setImmediate(callback, new PreparedStatementError('Statement is not prepared. Call prepare() first.', 'ENOTPREPARED'));\n      return this;\n    }\n\n    if (this._activeRequest) {\n      setImmediate(callback, new TransactionError(\"Can't acquire connection for the request. There is another request in progress.\", 'EREQINPROG'));\n      return this;\n    }\n\n    this._activeRequest = request;\n    setImmediate(callback, null, this._acquiredConnection, this._acquiredConfig);\n    return this;\n  }\n  /**\n   * Release connection back to the pool.\n   *\n   * @param {Connection} connection Previously acquired connection.\n   * @return {PreparedStatement}\n   */\n\n\n  release(connection) {\n    if (connection === this._acquiredConnection) {\n      this._activeRequest = null;\n    }\n\n    return this;\n  }\n  /**\n   * Add an input parameter to the prepared statement.\n   *\n   * @param {String} name Name of the input parameter without @ char.\n   * @param {*} type SQL data type of input parameter.\n   * @return {PreparedStatement}\n   */\n\n\n  input(name, type) {\n    if (/(--| |\\/\\*|\\*\\/|')/.test(name)) {\n      throw new PreparedStatementError(`SQL injection warning for param '${name}'`, 'EINJECT');\n    }\n\n    if (arguments.length < 2) {\n      throw new PreparedStatementError('Invalid number of arguments. 2 arguments expected.', 'EARGS');\n    }\n\n    if (type instanceof Function) {\n      type = type();\n    }\n\n    if (objectHasProperty(this.parameters, name)) {\n      throw new PreparedStatementError(`The parameter name ${name} has already been declared. Parameter names must be unique`, 'EDUPEPARAM');\n    }\n\n    this.parameters[name] = {\n      name,\n      type: type.type,\n      io: 1,\n      length: type.length,\n      scale: type.scale,\n      precision: type.precision,\n      tvpType: type.tvpType\n    };\n    return this;\n  }\n  /**\n   * Replace an input parameter on the request.\n   *\n   * @param {String} name Name of the input parameter without @ char.\n   * @param {*} [type] SQL data type of input parameter. If you omit type, module automaticaly decide which SQL data type should be used based on JS data type.\n   * @param {*} value Input parameter value. `undefined` and `NaN` values are automatically converted to `null` values.\n   * @return {Request}\n   */\n\n\n  replaceInput(name, type, value) {\n    delete this.parameters[name];\n    return this.input(name, type, value);\n  }\n  /**\n   * Add an output parameter to the prepared statement.\n   *\n   * @param {String} name Name of the output parameter without @ char.\n   * @param {*} type SQL data type of output parameter.\n   * @return {PreparedStatement}\n   */\n\n\n  output(name, type) {\n    if (/(--| |\\/\\*|\\*\\/|')/.test(name)) {\n      throw new PreparedStatementError(`SQL injection warning for param '${name}'`, 'EINJECT');\n    }\n\n    if (arguments.length < 2) {\n      throw new PreparedStatementError('Invalid number of arguments. 2 arguments expected.', 'EARGS');\n    }\n\n    if (type instanceof Function) type = type();\n\n    if (objectHasProperty(this.parameters, name)) {\n      throw new PreparedStatementError(`The parameter name ${name} has already been declared. Parameter names must be unique`, 'EDUPEPARAM');\n    }\n\n    this.parameters[name] = {\n      name,\n      type: type.type,\n      io: 2,\n      length: type.length,\n      scale: type.scale,\n      precision: type.precision\n    };\n    return this;\n  }\n  /**\n   * Replace an output parameter on the request.\n   *\n   * @param {String} name Name of the output parameter without @ char.\n   * @param {*} type SQL data type of output parameter.\n   * @return {PreparedStatement}\n   */\n\n\n  replaceOutput(name, type) {\n    delete this.parameters[name];\n    return this.output(name, type);\n  }\n  /**\n   * Prepare a statement.\n   *\n   * @param {String} statement SQL statement to prepare.\n   * @param {basicCallback} [callback] A callback which is called after preparation has completed, or an error has occurred. If omited, method returns Promise.\n   * @return {PreparedStatement|Promise}\n   */\n\n\n  prepare(statement, callback) {\n    if (typeof callback === 'function') {\n      this._prepare(statement, callback);\n\n      return this;\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      this._prepare(statement, err => {\n        if (err) return reject(err);\n        resolve(this);\n      });\n    });\n  }\n  /**\n   * @private\n   * @param {String} statement\n   * @param {basicCallback} callback\n   */\n\n\n  _prepare(statement, callback) {\n    debug('ps(%d): prepare', IDS.get(this));\n\n    if (typeof statement === 'function') {\n      callback = statement;\n      statement = undefined;\n    }\n\n    if (this.prepared) {\n      return setImmediate(callback, new PreparedStatementError('Statement is already prepared.', 'EALREADYPREPARED'));\n    }\n\n    this.statement = statement || this.statement;\n    this.parent.acquire(this, (err, connection, config) => {\n      if (err) return callback(err);\n      this._acquiredConnection = connection;\n      this._acquiredConfig = config;\n      const req = new shared.driver.Request(this);\n      req.stream = false;\n      req.output('handle', TYPES.Int);\n      req.input('params', TYPES.NVarChar, (() => {\n        const result = [];\n\n        for (const name in this.parameters) {\n          if (!objectHasProperty(this.parameters, name)) {\n            continue;\n          }\n\n          const param = this.parameters[name];\n          result.push(`@${name} ${declare(param.type, param)}${param.io === 2 ? ' output' : ''}`);\n        }\n\n        return result;\n      })().join(','));\n      req.input('stmt', TYPES.NVarChar, this.statement);\n      req.execute('sp_prepare', (err, result) => {\n        if (err) {\n          this.parent.release(this._acquiredConnection);\n          this._acquiredConnection = null;\n          this._acquiredConfig = null;\n          return callback(err);\n        }\n\n        debug('ps(%d): prepared', IDS.get(this));\n        this._handle = result.output.handle;\n        this.prepared = true;\n        callback(null);\n      });\n    });\n  }\n  /**\n   * Execute a prepared statement.\n   *\n   * @param {Object} values An object whose names correspond to the names of parameters that were added to the prepared statement before it was prepared.\n   * @param {basicCallback} [callback] A callback which is called after execution has completed, or an error has occurred. If omited, method returns Promise.\n   * @return {Request|Promise}\n   */\n\n\n  execute(values, callback) {\n    if (this.stream || typeof callback === 'function') {\n      return this._execute(values, callback);\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      this._execute(values, (err, recordset) => {\n        if (err) return reject(err);\n        resolve(recordset);\n      });\n    });\n  }\n  /**\n   * @private\n   * @param {Object} values\n   * @param {basicCallback} callback\n   */\n\n\n  _execute(values, callback) {\n    const req = new shared.driver.Request(this);\n    req.stream = this.stream;\n    req.arrayRowMode = this.arrayRowMode;\n    req.input('handle', TYPES.Int, this._handle); // copy parameters with new values\n\n    for (const name in this.parameters) {\n      if (!objectHasProperty(this.parameters, name)) {\n        continue;\n      }\n\n      const param = this.parameters[name];\n      req.parameters[name] = {\n        name,\n        type: param.type,\n        io: param.io,\n        value: values[name],\n        length: param.length,\n        scale: param.scale,\n        precision: param.precision\n      };\n    }\n\n    req.execute('sp_execute', (err, result) => {\n      if (err) return callback(err);\n      callback(null, result);\n    });\n    return req;\n  }\n  /**\n   * Unprepare a prepared statement.\n   *\n   * @param {basicCallback} [callback] A callback which is called after unpreparation has completed, or an error has occurred. If omited, method returns Promise.\n   * @return {PreparedStatement|Promise}\n   */\n\n\n  unprepare(callback) {\n    if (typeof callback === 'function') {\n      this._unprepare(callback);\n\n      return this;\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      this._unprepare(err => {\n        if (err) return reject(err);\n        resolve();\n      });\n    });\n  }\n  /**\n   * @private\n   * @param {basicCallback} callback\n   */\n\n\n  _unprepare(callback) {\n    debug('ps(%d): unprepare', IDS.get(this));\n\n    if (!this.prepared) {\n      return setImmediate(callback, new PreparedStatementError('Statement is not prepared. Call prepare() first.', 'ENOTPREPARED'));\n    }\n\n    if (this._activeRequest) {\n      return setImmediate(callback, new TransactionError(\"Can't unprepare the statement. There is a request in progress.\", 'EREQINPROG'));\n    }\n\n    const req = new shared.driver.Request(this);\n    req.stream = false;\n    req.input('handle', TYPES.Int, this._handle);\n    req.execute('sp_unprepare', err => {\n      if (err) return callback(err);\n      this.parent.release(this._acquiredConnection);\n      this._acquiredConnection = null;\n      this._acquiredConfig = null;\n      this._handle = 0;\n      this.prepared = false;\n      debug('ps(%d): unprepared', IDS.get(this));\n      return callback(null);\n    });\n  }\n\n}\n\nmodule.exports = PreparedStatement;","map":{"version":3,"sources":["C:/Users/matia/Documents/Git/Turismo-Real/front/pwa/node_modules/mssql/lib/base/prepared-statement.js"],"names":["debug","require","EventEmitter","IDS","objectHasProperty","globalConnection","TransactionError","PreparedStatementError","shared","TYPES","declare","PreparedStatement","constructor","parent","add","get","pool","_handle","prepared","parameters","config","connected","acquire","request","callback","_acquiredConnection","setImmediate","_activeRequest","_acquiredConfig","release","connection","input","name","type","test","arguments","length","Function","io","scale","precision","tvpType","replaceInput","value","output","replaceOutput","prepare","statement","_prepare","Promise","resolve","reject","err","undefined","req","driver","Request","stream","Int","NVarChar","result","param","push","join","execute","handle","values","_execute","recordset","arrayRowMode","unprepare","_unprepare","module","exports"],"mappings":"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","sourcesContent":["'use strict'\n\nconst debug = require('debug')('mssql:base')\nconst { EventEmitter } = require('events')\nconst { IDS, objectHasProperty } = require('../utils')\nconst globalConnection = require('../global-connection')\nconst { TransactionError, PreparedStatementError } = require('../error')\nconst shared = require('../shared')\nconst { TYPES, declare } = require('../datatypes')\n\n/**\n * Class PreparedStatement.\n *\n * IMPORTANT: Rememeber that each prepared statement means one reserved connection from the pool. Don't forget to unprepare a prepared statement!\n *\n * @property {String} statement Prepared SQL statement.\n */\n\nclass PreparedStatement extends EventEmitter {\n  /**\n   * Creates a new Prepared Statement.\n   *\n   * @param {ConnectionPool|Transaction} [holder]\n   */\n\n  constructor (parent) {\n    super()\n\n    IDS.add(this, 'PreparedStatement')\n    debug('ps(%d): created', IDS.get(this))\n\n    this.parent = parent || globalConnection.pool\n    this._handle = 0\n    this.prepared = false\n    this.parameters = {}\n  }\n\n  get config () {\n    return this.parent.config\n  }\n\n  get connected () {\n    return this.parent.connected\n  }\n\n  /**\n   * Acquire connection from connection pool.\n   *\n   * @param {Request} request Request.\n   * @param {ConnectionPool~acquireCallback} [callback] A callback which is called after connection has established, or an error has occurred. If omited, method returns Promise.\n   * @return {PreparedStatement|Promise}\n   */\n\n  acquire (request, callback) {\n    if (!this._acquiredConnection) {\n      setImmediate(callback, new PreparedStatementError('Statement is not prepared. Call prepare() first.', 'ENOTPREPARED'))\n      return this\n    }\n\n    if (this._activeRequest) {\n      setImmediate(callback, new TransactionError(\"Can't acquire connection for the request. There is another request in progress.\", 'EREQINPROG'))\n      return this\n    }\n\n    this._activeRequest = request\n    setImmediate(callback, null, this._acquiredConnection, this._acquiredConfig)\n    return this\n  }\n\n  /**\n   * Release connection back to the pool.\n   *\n   * @param {Connection} connection Previously acquired connection.\n   * @return {PreparedStatement}\n   */\n\n  release (connection) {\n    if (connection === this._acquiredConnection) {\n      this._activeRequest = null\n    }\n\n    return this\n  }\n\n  /**\n   * Add an input parameter to the prepared statement.\n   *\n   * @param {String} name Name of the input parameter without @ char.\n   * @param {*} type SQL data type of input parameter.\n   * @return {PreparedStatement}\n   */\n\n  input (name, type) {\n    if ((/(--| |\\/\\*|\\*\\/|')/).test(name)) {\n      throw new PreparedStatementError(`SQL injection warning for param '${name}'`, 'EINJECT')\n    }\n\n    if (arguments.length < 2) {\n      throw new PreparedStatementError('Invalid number of arguments. 2 arguments expected.', 'EARGS')\n    }\n\n    if (type instanceof Function) {\n      type = type()\n    }\n\n    if (objectHasProperty(this.parameters, name)) {\n      throw new PreparedStatementError(`The parameter name ${name} has already been declared. Parameter names must be unique`, 'EDUPEPARAM')\n    }\n\n    this.parameters[name] = {\n      name,\n      type: type.type,\n      io: 1,\n      length: type.length,\n      scale: type.scale,\n      precision: type.precision,\n      tvpType: type.tvpType\n    }\n\n    return this\n  }\n\n  /**\n   * Replace an input parameter on the request.\n   *\n   * @param {String} name Name of the input parameter without @ char.\n   * @param {*} [type] SQL data type of input parameter. If you omit type, module automaticaly decide which SQL data type should be used based on JS data type.\n   * @param {*} value Input parameter value. `undefined` and `NaN` values are automatically converted to `null` values.\n   * @return {Request}\n   */\n\n  replaceInput (name, type, value) {\n    delete this.parameters[name]\n\n    return this.input(name, type, value)\n  }\n\n  /**\n   * Add an output parameter to the prepared statement.\n   *\n   * @param {String} name Name of the output parameter without @ char.\n   * @param {*} type SQL data type of output parameter.\n   * @return {PreparedStatement}\n   */\n\n  output (name, type) {\n    if (/(--| |\\/\\*|\\*\\/|')/.test(name)) {\n      throw new PreparedStatementError(`SQL injection warning for param '${name}'`, 'EINJECT')\n    }\n\n    if (arguments.length < 2) {\n      throw new PreparedStatementError('Invalid number of arguments. 2 arguments expected.', 'EARGS')\n    }\n\n    if (type instanceof Function) type = type()\n\n    if (objectHasProperty(this.parameters, name)) {\n      throw new PreparedStatementError(`The parameter name ${name} has already been declared. Parameter names must be unique`, 'EDUPEPARAM')\n    }\n\n    this.parameters[name] = {\n      name,\n      type: type.type,\n      io: 2,\n      length: type.length,\n      scale: type.scale,\n      precision: type.precision\n    }\n\n    return this\n  }\n\n  /**\n   * Replace an output parameter on the request.\n   *\n   * @param {String} name Name of the output parameter without @ char.\n   * @param {*} type SQL data type of output parameter.\n   * @return {PreparedStatement}\n   */\n\n  replaceOutput (name, type) {\n    delete this.parameters[name]\n\n    return this.output(name, type)\n  }\n\n  /**\n   * Prepare a statement.\n   *\n   * @param {String} statement SQL statement to prepare.\n   * @param {basicCallback} [callback] A callback which is called after preparation has completed, or an error has occurred. If omited, method returns Promise.\n   * @return {PreparedStatement|Promise}\n   */\n\n  prepare (statement, callback) {\n    if (typeof callback === 'function') {\n      this._prepare(statement, callback)\n      return this\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      this._prepare(statement, err => {\n        if (err) return reject(err)\n        resolve(this)\n      })\n    })\n  }\n\n  /**\n   * @private\n   * @param {String} statement\n   * @param {basicCallback} callback\n   */\n\n  _prepare (statement, callback) {\n    debug('ps(%d): prepare', IDS.get(this))\n\n    if (typeof statement === 'function') {\n      callback = statement\n      statement = undefined\n    }\n\n    if (this.prepared) {\n      return setImmediate(callback, new PreparedStatementError('Statement is already prepared.', 'EALREADYPREPARED'))\n    }\n\n    this.statement = statement || this.statement\n\n    this.parent.acquire(this, (err, connection, config) => {\n      if (err) return callback(err)\n\n      this._acquiredConnection = connection\n      this._acquiredConfig = config\n\n      const req = new shared.driver.Request(this)\n      req.stream = false\n      req.output('handle', TYPES.Int)\n      req.input('params', TYPES.NVarChar, ((() => {\n        const result = []\n        for (const name in this.parameters) {\n          if (!objectHasProperty(this.parameters, name)) {\n            continue\n          }\n          const param = this.parameters[name]\n          result.push(`@${name} ${declare(param.type, param)}${param.io === 2 ? ' output' : ''}`)\n        }\n        return result\n      })()).join(','))\n      req.input('stmt', TYPES.NVarChar, this.statement)\n      req.execute('sp_prepare', (err, result) => {\n        if (err) {\n          this.parent.release(this._acquiredConnection)\n          this._acquiredConnection = null\n          this._acquiredConfig = null\n\n          return callback(err)\n        }\n\n        debug('ps(%d): prepared', IDS.get(this))\n\n        this._handle = result.output.handle\n        this.prepared = true\n\n        callback(null)\n      })\n    })\n  }\n\n  /**\n   * Execute a prepared statement.\n   *\n   * @param {Object} values An object whose names correspond to the names of parameters that were added to the prepared statement before it was prepared.\n   * @param {basicCallback} [callback] A callback which is called after execution has completed, or an error has occurred. If omited, method returns Promise.\n   * @return {Request|Promise}\n   */\n\n  execute (values, callback) {\n    if (this.stream || (typeof callback === 'function')) {\n      return this._execute(values, callback)\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      this._execute(values, (err, recordset) => {\n        if (err) return reject(err)\n        resolve(recordset)\n      })\n    })\n  }\n\n  /**\n   * @private\n   * @param {Object} values\n   * @param {basicCallback} callback\n   */\n\n  _execute (values, callback) {\n    const req = new shared.driver.Request(this)\n    req.stream = this.stream\n    req.arrayRowMode = this.arrayRowMode\n    req.input('handle', TYPES.Int, this._handle)\n\n    // copy parameters with new values\n    for (const name in this.parameters) {\n      if (!objectHasProperty(this.parameters, name)) {\n        continue\n      }\n      const param = this.parameters[name]\n      req.parameters[name] = {\n        name,\n        type: param.type,\n        io: param.io,\n        value: values[name],\n        length: param.length,\n        scale: param.scale,\n        precision: param.precision\n      }\n    }\n\n    req.execute('sp_execute', (err, result) => {\n      if (err) return callback(err)\n\n      callback(null, result)\n    })\n\n    return req\n  }\n\n  /**\n   * Unprepare a prepared statement.\n   *\n   * @param {basicCallback} [callback] A callback which is called after unpreparation has completed, or an error has occurred. If omited, method returns Promise.\n   * @return {PreparedStatement|Promise}\n   */\n\n  unprepare (callback) {\n    if (typeof callback === 'function') {\n      this._unprepare(callback)\n      return this\n    }\n\n    return new shared.Promise((resolve, reject) => {\n      this._unprepare(err => {\n        if (err) return reject(err)\n        resolve()\n      })\n    })\n  }\n\n  /**\n   * @private\n   * @param {basicCallback} callback\n   */\n\n  _unprepare (callback) {\n    debug('ps(%d): unprepare', IDS.get(this))\n\n    if (!this.prepared) {\n      return setImmediate(callback, new PreparedStatementError('Statement is not prepared. Call prepare() first.', 'ENOTPREPARED'))\n    }\n\n    if (this._activeRequest) {\n      return setImmediate(callback, new TransactionError(\"Can't unprepare the statement. There is a request in progress.\", 'EREQINPROG'))\n    }\n\n    const req = new shared.driver.Request(this)\n    req.stream = false\n    req.input('handle', TYPES.Int, this._handle)\n    req.execute('sp_unprepare', err => {\n      if (err) return callback(err)\n\n      this.parent.release(this._acquiredConnection)\n      this._acquiredConnection = null\n      this._acquiredConfig = null\n      this._handle = 0\n      this.prepared = false\n\n      debug('ps(%d): unprepared', IDS.get(this))\n\n      return callback(null)\n    })\n  }\n}\n\nmodule.exports = PreparedStatement\n"]},"metadata":{},"sourceType":"script"}