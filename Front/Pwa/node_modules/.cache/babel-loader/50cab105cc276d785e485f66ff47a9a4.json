{"ast":null,"code":"\"use strict\";\n\nvar _classCallCheck = require(\"C:/Users/jesus/Documents/GitHub/Turismo-Real/Front/Pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"C:/Users/jesus/Documents/GitHub/Turismo-Real/Front/Pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nvar _inherits = require(\"C:/Users/jesus/Documents/GitHub/Turismo-Real/Front/Pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/inherits\");\n\nvar _createSuper = require(\"C:/Users/jesus/Documents/GitHub/Turismo-Real/Front/Pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createSuper\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar tls = _interopRequireWildcard(require(\"tls\"));\n\nvar _events = require(\"events\");\n\nvar _message = _interopRequireDefault(require(\"./message\"));\n\nvar _packet = require(\"./packet\");\n\nvar _incomingMessageStream = _interopRequireDefault(require(\"./incoming-message-stream\"));\n\nvar _outgoingMessageStream = _interopRequireDefault(require(\"./outgoing-message-stream\"));\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction _getRequireWildcardCache(nodeInterop) {\n  if (typeof WeakMap !== \"function\") return null;\n  var cacheBabelInterop = new WeakMap();\n  var cacheNodeInterop = new WeakMap();\n  return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) {\n    return nodeInterop ? cacheNodeInterop : cacheBabelInterop;\n  })(nodeInterop);\n}\n\nfunction _interopRequireWildcard(obj, nodeInterop) {\n  if (!nodeInterop && obj && obj.__esModule) {\n    return obj;\n  }\n\n  if (obj === null || typeof obj !== \"object\" && typeof obj !== \"function\") {\n    return {\n      default: obj\n    };\n  }\n\n  var cache = _getRequireWildcardCache(nodeInterop);\n\n  if (cache && cache.has(obj)) {\n    return cache.get(obj);\n  }\n\n  var newObj = {};\n  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;\n\n  for (var key in obj) {\n    if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) {\n      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;\n\n      if (desc && (desc.get || desc.set)) {\n        Object.defineProperty(newObj, key, desc);\n      } else {\n        newObj[key] = obj[key];\n      }\n    }\n  }\n\n  newObj.default = obj;\n\n  if (cache) {\n    cache.set(obj, newObj);\n  }\n\n  return newObj;\n} // eslint-disable-next-line @typescript-eslint/no-var-requires\n\n\nvar DuplexPair = require('native-duplexpair');\n\nvar MessageIO = /*#__PURE__*/function (_events$EventEmitter) {\n  _inherits(MessageIO, _events$EventEmitter);\n\n  var _super = _createSuper(MessageIO);\n\n  function MessageIO(socket, packetSize, debug) {\n    var _this;\n\n    _classCallCheck(this, MessageIO);\n\n    _this = _super.call(this);\n    _this.socket = void 0;\n    _this.debug = void 0;\n    _this.tlsNegotiationComplete = void 0;\n    _this.incomingMessageStream = void 0;\n    _this.outgoingMessageStream = void 0;\n    _this.securePair = void 0;\n    _this.socket = socket;\n    _this.debug = debug;\n    _this.tlsNegotiationComplete = false;\n    _this.incomingMessageStream = new _incomingMessageStream.default(_this.debug);\n\n    _this.incomingMessageStream.on('data', function (message) {\n      _this.emit('data', message);\n    });\n\n    _this.incomingMessageStream.on('error', function (message) {\n      _this.emit('error', message);\n    });\n\n    _this.outgoingMessageStream = new _outgoingMessageStream.default(_this.debug, {\n      packetSize: packetSize\n    });\n\n    _this.socket.pipe(_this.incomingMessageStream);\n\n    _this.outgoingMessageStream.pipe(_this.socket);\n\n    return _this;\n  }\n\n  _createClass(MessageIO, [{\n    key: \"packetSize\",\n    value: function packetSize() {\n      if (arguments.length > 0) {\n        var packetSize = arguments.length <= 0 ? undefined : arguments[0];\n        this.debug.log('Packet size changed from ' + this.outgoingMessageStream.packetSize + ' to ' + packetSize);\n        this.outgoingMessageStream.packetSize = packetSize;\n      }\n\n      if (this.securePair) {\n        this.securePair.cleartext.setMaxSendFragment(this.outgoingMessageStream.packetSize);\n      }\n\n      return this.outgoingMessageStream.packetSize;\n    }\n  }, {\n    key: \"startTls\",\n    value: function startTls(secureContext, hostname, trustServerCertificate) {\n      var _this2 = this;\n\n      var duplexpair = new DuplexPair();\n      var securePair = this.securePair = {\n        cleartext: tls.connect({\n          socket: duplexpair.socket1,\n          servername: hostname,\n          secureContext: secureContext,\n          rejectUnauthorized: !trustServerCertificate\n        }),\n        encrypted: duplexpair.socket2\n      }; // If an error happens in the TLS layer, there is nothing we can do about it.\n      // Forward the error to the socket so the connection gets properly cleaned up.\n\n      securePair.cleartext.on('error', function (err) {\n        // Streams in node.js versions before 8.0.0 don't support `.destroy`\n        if (typeof securePair.encrypted.destroy === 'function') {\n          securePair.encrypted.destroy();\n        }\n\n        _this2.socket.destroy(err);\n      });\n      securePair.cleartext.on('secureConnect', function () {\n        var cipher = securePair.cleartext.getCipher();\n\n        if (cipher) {\n          _this2.debug.log('TLS negotiated (' + cipher.name + ', ' + cipher.version + ')');\n        }\n\n        _this2.emit('secure', securePair.cleartext);\n\n        _this2.encryptAllFutureTraffic();\n      });\n      securePair.encrypted.on('data', function (data) {\n        _this2.sendMessage(_packet.TYPE.PRELOGIN, data, false);\n      });\n    }\n  }, {\n    key: \"encryptAllFutureTraffic\",\n    value: function encryptAllFutureTraffic() {\n      var securePair = this.securePair;\n      securePair.cleartext.setMaxSendFragment(this.outgoingMessageStream.packetSize);\n      securePair.encrypted.removeAllListeners('data');\n      this.outgoingMessageStream.unpipe(this.socket);\n      this.socket.unpipe(this.incomingMessageStream);\n      this.socket.pipe(securePair.encrypted);\n      securePair.encrypted.pipe(this.socket);\n      securePair.cleartext.pipe(this.incomingMessageStream);\n      this.outgoingMessageStream.pipe(securePair.cleartext);\n      this.tlsNegotiationComplete = true;\n    }\n  }, {\n    key: \"tlsHandshakeData\",\n    value: function tlsHandshakeData(data) {\n      var securePair = this.securePair;\n      securePair.encrypted.write(data);\n    } // TODO listen for 'drain' event when socket.write returns false.\n    // TODO implement incomplete request cancelation (2.2.1.6)\n\n  }, {\n    key: \"sendMessage\",\n    value: function sendMessage(packetType, data, resetConnection) {\n      var message = new _message.default({\n        type: packetType,\n        resetConnection: resetConnection\n      });\n      message.end(data);\n      this.outgoingMessageStream.write(message);\n      return message;\n    } // Temporarily suspends the flow of incoming packets.\n\n  }, {\n    key: \"pause\",\n    value: function pause() {\n      this.incomingMessageStream.pause();\n    } // Resumes the flow of incoming packets.\n\n  }, {\n    key: \"resume\",\n    value: function resume() {\n      this.incomingMessageStream.resume();\n    }\n  }]);\n\n  return MessageIO;\n}(_events.EventEmitter);\n\nvar _default = MessageIO;\nexports.default = _default;\nmodule.exports = MessageIO;","map":{"version":3,"sources":["C:/Users/jesus/Documents/GitHub/Turismo-Real/Front/Pwa/node_modules/mssql/node_modules/tedious/lib/message-io.js"],"names":["Object","defineProperty","exports","value","default","tls","_interopRequireWildcard","require","_events","_message","_interopRequireDefault","_packet","_incomingMessageStream","_outgoingMessageStream","obj","__esModule","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","cache","has","get","newObj","hasPropertyDescriptor","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","DuplexPair","MessageIO","socket","packetSize","debug","tlsNegotiationComplete","incomingMessageStream","outgoingMessageStream","securePair","on","message","emit","pipe","length","log","cleartext","setMaxSendFragment","secureContext","hostname","trustServerCertificate","duplexpair","connect","socket1","servername","rejectUnauthorized","encrypted","socket2","err","destroy","cipher","getCipher","name","version","encryptAllFutureTraffic","data","sendMessage","TYPE","PRELOGIN","removeAllListeners","unpipe","write","packetType","resetConnection","type","end","pause","resume","EventEmitter","_default","module"],"mappings":"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","sourcesContent":["\"use strict\";\r\n\r\nObject.defineProperty(exports, \"__esModule\", {\r\n  value: true\r\n});\r\nexports.default = void 0;\r\n\r\nvar tls = _interopRequireWildcard(require(\"tls\"));\r\n\r\nvar _events = require(\"events\");\r\n\r\nvar _message = _interopRequireDefault(require(\"./message\"));\r\n\r\nvar _packet = require(\"./packet\");\r\n\r\nvar _incomingMessageStream = _interopRequireDefault(require(\"./incoming-message-stream\"));\r\n\r\nvar _outgoingMessageStream = _interopRequireDefault(require(\"./outgoing-message-stream\"));\r\n\r\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\r\n\r\nfunction _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== \"function\") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }\r\n\r\nfunction _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== \"object\" && typeof obj !== \"function\") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-var-requires\r\nconst DuplexPair = require('native-duplexpair');\r\n\r\nclass MessageIO extends _events.EventEmitter {\r\n  constructor(socket, packetSize, debug) {\r\n    super();\r\n    this.socket = void 0;\r\n    this.debug = void 0;\r\n    this.tlsNegotiationComplete = void 0;\r\n    this.incomingMessageStream = void 0;\r\n    this.outgoingMessageStream = void 0;\r\n    this.securePair = void 0;\r\n    this.socket = socket;\r\n    this.debug = debug;\r\n    this.tlsNegotiationComplete = false;\r\n    this.incomingMessageStream = new _incomingMessageStream.default(this.debug);\r\n    this.incomingMessageStream.on('data', message => {\r\n      this.emit('data', message);\r\n    });\r\n    this.incomingMessageStream.on('error', message => {\r\n      this.emit('error', message);\r\n    });\r\n    this.outgoingMessageStream = new _outgoingMessageStream.default(this.debug, {\r\n      packetSize: packetSize\r\n    });\r\n    this.socket.pipe(this.incomingMessageStream);\r\n    this.outgoingMessageStream.pipe(this.socket);\r\n  }\r\n\r\n  packetSize(...args) {\r\n    if (args.length > 0) {\r\n      const packetSize = args[0];\r\n      this.debug.log('Packet size changed from ' + this.outgoingMessageStream.packetSize + ' to ' + packetSize);\r\n      this.outgoingMessageStream.packetSize = packetSize;\r\n    }\r\n\r\n    if (this.securePair) {\r\n      this.securePair.cleartext.setMaxSendFragment(this.outgoingMessageStream.packetSize);\r\n    }\r\n\r\n    return this.outgoingMessageStream.packetSize;\r\n  }\r\n\r\n  startTls(secureContext, hostname, trustServerCertificate) {\r\n    const duplexpair = new DuplexPair();\r\n    const securePair = this.securePair = {\r\n      cleartext: tls.connect({\r\n        socket: duplexpair.socket1,\r\n        servername: hostname,\r\n        secureContext: secureContext,\r\n        rejectUnauthorized: !trustServerCertificate\r\n      }),\r\n      encrypted: duplexpair.socket2\r\n    }; // If an error happens in the TLS layer, there is nothing we can do about it.\r\n    // Forward the error to the socket so the connection gets properly cleaned up.\r\n\r\n    securePair.cleartext.on('error', err => {\r\n      // Streams in node.js versions before 8.0.0 don't support `.destroy`\r\n      if (typeof securePair.encrypted.destroy === 'function') {\r\n        securePair.encrypted.destroy();\r\n      }\r\n\r\n      this.socket.destroy(err);\r\n    });\r\n    securePair.cleartext.on('secureConnect', () => {\r\n      const cipher = securePair.cleartext.getCipher();\r\n\r\n      if (cipher) {\r\n        this.debug.log('TLS negotiated (' + cipher.name + ', ' + cipher.version + ')');\r\n      }\r\n\r\n      this.emit('secure', securePair.cleartext);\r\n      this.encryptAllFutureTraffic();\r\n    });\r\n    securePair.encrypted.on('data', data => {\r\n      this.sendMessage(_packet.TYPE.PRELOGIN, data, false);\r\n    });\r\n  }\r\n\r\n  encryptAllFutureTraffic() {\r\n    const securePair = this.securePair;\r\n    securePair.cleartext.setMaxSendFragment(this.outgoingMessageStream.packetSize);\r\n    securePair.encrypted.removeAllListeners('data');\r\n    this.outgoingMessageStream.unpipe(this.socket);\r\n    this.socket.unpipe(this.incomingMessageStream);\r\n    this.socket.pipe(securePair.encrypted);\r\n    securePair.encrypted.pipe(this.socket);\r\n    securePair.cleartext.pipe(this.incomingMessageStream);\r\n    this.outgoingMessageStream.pipe(securePair.cleartext);\r\n    this.tlsNegotiationComplete = true;\r\n  }\r\n\r\n  tlsHandshakeData(data) {\r\n    const securePair = this.securePair;\r\n    securePair.encrypted.write(data);\r\n  } // TODO listen for 'drain' event when socket.write returns false.\r\n  // TODO implement incomplete request cancelation (2.2.1.6)\r\n\r\n\r\n  sendMessage(packetType, data, resetConnection) {\r\n    const message = new _message.default({\r\n      type: packetType,\r\n      resetConnection: resetConnection\r\n    });\r\n    message.end(data);\r\n    this.outgoingMessageStream.write(message);\r\n    return message;\r\n  } // Temporarily suspends the flow of incoming packets.\r\n\r\n\r\n  pause() {\r\n    this.incomingMessageStream.pause();\r\n  } // Resumes the flow of incoming packets.\r\n\r\n\r\n  resume() {\r\n    this.incomingMessageStream.resume();\r\n  }\r\n\r\n}\r\n\r\nvar _default = MessageIO;\r\nexports.default = _default;\r\nmodule.exports = MessageIO;"]},"metadata":{},"sourceType":"script"}